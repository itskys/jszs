<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025å¹´çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ(ç®€æ˜“ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2d5a27;
            --accent: #d9534f;
            --blue: #007bff;
            --review-bg: #fff3cd;
            --review-text: #856404;
            --bg: #f4f4f9;
            --card: #fff;
            --text: #333;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text);
            line-height: 1.5;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 80px;
            flex: 1;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-box {
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            font-weight: 900;
            font-size: 28px;
            line-height: 50px;
            text-align: center;
            border-radius: 8px;
            letter-spacing: -2px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }

        .header h1 {
            color: var(--primary);
            margin: 5px 0;
            font-size: 22px;
        }

        .sub-title {
            color: #666;
            font-size: 13px;
        }

        .card-box {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            box-shadow: 0 3px #1e3d1a;
            width: 100%;
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px #1e3d1a;
        }

        .btn.danger {
            background: var(--accent);
            box-shadow: 0 3px #c9302c;
        }

        .btn.secondary {
            background: #6c757d;
            box-shadow: 0 3px #545b62;
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-group input:focus {
            border-color: var(--primary);
            outline: none;
        }

        #history-section {
            margin-top: 20px;
            border-top: 1px dashed #ccc;
            padding-top: 15px;
        }

        .history-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed;
        }

        .history-table th {
            text-align: center;
            color: #666;
            border-bottom: 2px solid #eee;
            padding: 8px 2px;
            background: #f8f9fa;
        }

        .history-table td {
            padding: 8px 2px;
            border-bottom: 1px solid #eee;
            text-align: center;
            color: #555;
        }

        .history-score {
            color: var(--accent);
            font-weight: bold;
            font-size: 14px;
        }

        .history-row-clickable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-row-clickable:active {
            background-color: #f0f0f0;
        }

        .history-row-clickable td:first-child {
            color: var(--blue);
            font-weight: 500;
        }

        .clear-hist-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 12px;
            text-decoration: underline;
            margin-top: 10px;
            padding: 5px;
            cursor: pointer;
        }

        #exam-screen {
            display: none;
            padding-top: 5px;
        }

        .top-bar-compact {
            position: sticky;
            top: 0;
            z-index: 900;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: -15px -15px 15px -15px;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
            transition: all 0.3s;
        }

        .top-bar-review {
            background: var(--review-bg);
            border-bottom: 1px solid #ffeeba;
        }

        .timer-compact {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            color: var(--accent);
            white-space: nowrap;
        }

        .submit-compact-btn {
            padding: 6px 12px;
            font-size: 13px;
            margin: 0;
            box-shadow: none;
            width: auto;
            white-space: nowrap;
            background: var(--accent);
        }

        .question-card {
            background: var(--card);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            scroll-margin-top: 80px;
        }

        .q-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .q-tag {
            background: var(--primary);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            margin-top: 3px;
        }

        .option-item {
            display: flex;
            align-items: flex-start;
            min-height: 48px;
            margin: 10px 0;
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .option-item input {
            margin-top: 4px;
            margin-right: 10px;
            transform: scale(1.3);
        }

        .option-item.selected {
            background: #e8f5e9;
            border-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .analysis-box {
            background: var(--review-bg);
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            color: var(--review-text);
            display: none;
            font-size: 14px;
        }

        .show-analysis .analysis-box {
            display: block;
        }

        .wrong-ans .q-header {
            color: var(--accent);
        }

        .wrong-ans .option-item.selected {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .fab-card-btn {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 10px;
            line-height: 1.2;
        }

        .fab-card-btn:active {
            transform: scale(0.95);
        }

        .card-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2100;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card-modal.active {
            display: flex;
            opacity: 1;
        }

        .card-content {
            background: #fff;
            width: 100%;
            height: 80%;
            margin-top: auto;
            border-radius: 20px 20px 0 0;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .card-modal.active .card-content {
            transform: translateY(0);
        }

        .card-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--primary);
        }

        .close-card-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            padding: 0 10px;
        }

        .card-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .card-section {
            margin-bottom: 20px;
        }

        .card-sec-title {
            background: #f8f9fa;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 14px;
            color: #555;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 10px;
        }

        .card-item {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fff;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
        }

        .card-item.answered {
            background: var(--blue);
            color: white;
            border-color: var(--blue);
        }

        .card-item.correct {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .card-item.wrong {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .footer {
            text-align: center;
            padding: 20px 0;
            font-size: 12px;
            color: #aaa;
            border-top: 1px solid #eee;
            margin-top: auto;
        }

        /* ç®€æ˜“ç‰ˆç‹¬æœ‰çš„é»„è‰²è¯´æ˜æ¡† */
        .disclaimer-box {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            border: 1px solid #ffeeba;
            line-height: 1.6;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header" id="main-header">
            <div class="logo-box">KK</div>
            <h1>2025å¹´çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ</h1>
            <div class="sub-title">é—­å·æœºè¯•(ç®€æ˜“ç‰ˆ) | é™æ—¶60åˆ†é’Ÿ | æ€»åˆ†100åˆ†</div>
        </div>

        <div id="welcome-screen" class="card-box">
            <h2 style="text-align: center; color:var(--primary); margin-top:0;">è€ƒç”Ÿä¿¡æ¯å½•å…¥</h2>

            <div class="disclaimer-box">
                <strong>âš ï¸ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                æœ¬ç³»ç»Ÿä¸ºè®¡ç®—æœºç¨‹åºä»é¢˜åº“ä¸­æŠ½å–ï¼Œç”±äºé¢˜é‡å¤ªå¤§ï¼Œæ— æ³•ä¸€ä¸€æ ¸å®ï¼Œä¹Ÿæ— æ³•ä¿è¯é¢˜ç›®å®Œå…¨æ­£ç¡®ã€‚ä»…ç”¨äºå½¢å¼ç»ƒä¹ ï¼Œæ— æ³•æ›¿ä»£å®Œæ•´å¤ä¹ ã€‚å…è´¹ä½¿ç”¨æœ¬ç³»ç»Ÿï¼Œä½œè€…å…è´£ã€‚ç‚¹å‡»â€œå¼€å§‹è€ƒè¯•â€å³ä»£è¡¨åŒæ„ã€‚
            </div>

            <div
                style="background:#eef7ee; padding:15px; border-radius:8px; font-size:14px; color:#333; margin-bottom:20px;">
                <p><strong>ğŸ¯ è€ƒè¯•è§„åˆ™ï¼š</strong></p>
                <ul style="padding-left:20px; margin:5px 0;">
                    <li><strong>é¢˜é‡ï¼š</strong>300é¢˜ (å•é€‰150+å¤šé€‰100+åˆ¤æ–­50)</li>
                    <li><strong>æ—¶é•¿ï¼š</strong>60åˆ†é’Ÿ (äº¤å·åè‡ªåŠ¨ä¸Šä¼ æˆç»©)</li>
                </ul>
            </div>

            <div class="input-group">
                <label>å§“åï¼š</label>
                <input type="text" id="student-name" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
            </div>
            <div class="input-group">
                <label>å­¦å· / ç­çº§ï¼š</label>
                <input type="text" id="student-id" placeholder="ä¾‹å¦‚ï¼š23çº§è®¡ç®—æœº1ç­">
            </div>

            <button class="btn" onclick="startExamWithCheck()">å¼€å§‹è€ƒè¯•</button>

            <div id="history-section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>ğŸ“œ æœ¬æœºç»ƒä¹ å†å²</strong>
                    <button class="clear-hist-btn" onclick="clearHistory()">æ¸…ç©ºè®°å½•</button>
                </div>
                <div id="history-list-container">
                    <p style="color:#999; font-size:12px; text-align:center;">æš‚æ— ç»ƒä¹ è®°å½•</p>
                </div>
                <p style="font-size:11px; color:#999; text-align:center; margin-top:5px;">ğŸ’¡ ç‚¹å‡»å†å²è®°å½•å¯ã€å¤ç›˜ã€‘æ•´å¥—è¯•å·è¯¦æƒ…</p>
            </div>
        </div>

        <div id="exam-screen">
            <div class="top-bar-compact" id="exam-top-bar">
                <div class="timer-compact" id="timer">60:00</div>
                <div style="flex:1;"></div>
                <button class="btn danger submit-compact-btn" onclick="submitExam(true)">äº¤å·</button>
            </div>

            <div class="top-bar-compact top-bar-review" id="review-top-bar" style="display:none;">
                <div style="font-weight:bold; color:var(--review-text); font-size:14px;">ğŸ“– å†å²å¤ç›˜æ¨¡å¼</div>
                <div style="display:flex; gap:10px;">
                    <button class="mini-nav-btn" id="filter-btn" onclick="toggleWrongOnly(this)"
                        style="width:auto; padding:5px 12px; background:#fff; border-color:#d4a845;">åªçœ‹é”™é¢˜</button>
                    <button class="submit-compact-btn" onclick="location.reload()"
                        style="background:#6c757d;">é€€å‡º</button>
                </div>
            </div>

            <div id="paper-content"></div>

            <div id="exam-bottom-action" style="padding: 20px 0;">
                <button class="btn danger" onclick="submitExam(true)">ç¡®è®¤æäº¤è¯•å·</button>
            </div>

            <div class="fab-card-btn" id="fab-btn" onclick="toggleAnswerCard()">
                <i>ğŸ“„</i>
                <span id="fab-progress">0/300</span>
            </div>
        </div>

        <div class="card-modal" id="answer-card-modal" onclick="if(event.target===this) toggleAnswerCard()">
            <div class="card-content">
                <div class="card-header">
                    <h3>ç­”é¢˜å¡</h3>
                    <button class="close-card-btn" onclick="toggleAnswerCard()">Ã—</button>
                </div>
                <div class="card-body" id="answer-card-body">
                </div>
            </div>
        </div>

        <div id="result-screen" class="card-box" style="display:none; text-align:center;">
            <h2 style="color:var(--primary)">è€ƒè¯•ç»“æŸ</h2>

            <p style="color:#666; margin:5px 0;">è€ƒç”Ÿï¼š<strong id="result-student-name">--</strong></p>

            <div style="font-size:50px; font-weight:900; color:var(--primary); margin:10px 0;">
                <span id="score-display">0</span> <span style="font-size:18px; color:#666;">åˆ†</span>
            </div>
            <p>ç­”å¯¹: <strong id="correct-count">0</strong> / 300 é¢˜</p>

            <div
                style="background:#fff3cd; padding:10px; border-radius:6px; color:#856404; font-size:14px; margin:20px 0;">
                <span id="upload-status">â³ æ­£åœ¨ä¸Šä¼ æˆç»©...</span><br>
                <span style="font-size:12px; color:#999;">(é”™é¢˜å·²æ ‡çº¢ï¼Œå¯ä¸‹æ»‘æˆ–ä½¿ç”¨ç­”é¢˜å¡æŸ¥çœ‹)</span>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn secondary" onclick="reviewWrong()">æŸ¥çœ‹é”™é¢˜</button>
                <button class="btn" onclick="location.reload()">å†ç»ƒä¸€æ¬¡</button>
            </div>
        </div>

        <div class="footer">
            ç‰ˆæƒæ‰€æœ‰ &copy; 2025 çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ<br>
            Created By <span>Kingkong</span>
        </div>
    </div>

    <script src="questions_data.js"></script>

    <script>
        // ============================================
        // V2.0 æ ¸å¿ƒé€»è¾‘ (ç®€æ˜“ç‰ˆ)
        // ============================================

        // ã€å·®å¼‚ç‚¹1ã€‘ç‰ˆæœ¬æ ‡è¯†ï¼šç²¾ç®€ç‰ˆ
        const EXAM_VERSION = "ç²¾ç®€ç‰ˆ";

        // å…¨å±€å˜é‡å®šä¹‰
        let currentPaper = [];
        let userAnswers = {};
        let timeLeft = 3600;
        let timerId = null;
        let isExamFinished = false;
        let isWrongOnlyMode = false;
        let globalIndexMap = {};
        let currentStudent = { name: "", id: "" };

        // å…¨å±€é¢˜åº“ç´¢å¼•ï¼Œç”¨äºå†å²è®°å½•å›æº¯
        let QUESTION_MAP = {};

        // åˆ‡å±è®¡æ•°å™¨
        let switchScreenCount = 0;

        window.onload = function () {
            initQuestionMap();
            renderHistory();
        };

        function initQuestionMap() {
            if (typeof QUESTION_DB !== 'undefined') {
                ['single', 'multi', 'tf'].forEach(type => {
                    QUESTION_DB[type].forEach(q => {
                        QUESTION_MAP[q.id] = q;
                    });
                });
            }
        }

        // åˆ‡å±æ£€æµ‹é€»è¾‘
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && document.getElementById('exam-screen').style.display === 'block' && !isExamFinished) {
                switchScreenCount++;
                document.title = "âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°åˆ‡å±ï¼";
            } else {
                document.title = "2025å¹´çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ";
            }
        });

        function shuffle(arr) {
            let m = arr.length, t, i;
            while (m) {
                i = Math.floor(Math.random() * m--);
                t = arr[m]; arr[m] = arr[i]; arr[i] = t;
            }
            return arr;
        }

        window.onbeforeunload = function (e) {
            if (!isExamFinished && document.getElementById('exam-screen').style.display === 'block') {
                e.returnValue = 'è€ƒè¯•è¿›è¡Œä¸­ï¼Œç¦»å¼€å°†ä¸¢å¤±è¿›åº¦';
                return e.returnValue;
            }
        };

        function startExamWithCheck() {
            const nameInp = document.getElementById('student-name');
            const idInp = document.getElementById('student-id');
            const name = nameInp.value.trim();
            const id = idInp.value.trim();

            if (!name || !id) {
                alert("è¯·å…ˆå¡«å†™ã€å§“åã€‘å’Œã€å­¦å·/ç­çº§ã€‘ï¼Œæ‰èƒ½å¼€å§‹è€ƒè¯•ï¼");
                nameInp.focus();
                return;
            }

            currentStudent.name = name;
            currentStudent.id = id;
            startExam();
        }

        // ã€å·®å¼‚ç‚¹2ã€‘æŠ½é¢˜é€»è¾‘ï¼šåªæŠ½å–å‰50%
        function startExam() {
            if (typeof QUESTION_DB === 'undefined') {
                alert("é”™è¯¯ï¼šæœªæ‰¾åˆ°é¢˜åº“æ–‡ä»¶ questions_data.js");
                return;
            }

            userAnswers = {};
            switchScreenCount = 0;

            // --- ç®€æ˜“ç‰ˆæ ¸å¿ƒé€»è¾‘ï¼šåŠåº“é”å®š ---
            const POOL_RATIO = 0.5;
            const targetSingle = 150;
            const targetMulti = 100;
            const targetTf = 50;

            function getQuestionsFromTopPool(sourceArray, targetCount) {
                const total = sourceArray.length;
                let limitPoint = Math.floor(total * POOL_RATIO);
                if (limitPoint < targetCount) limitPoint = targetCount;

                // åªåˆ‡å–å‰ limitPoint ä¸ªé¢˜ç›®ä½œä¸ºæŠ½æ ·æ± 
                const validPool = sourceArray.slice(0, limitPoint);
                return shuffle([...validPool]).slice(0, targetCount);
            }

            const singles = getQuestionsFromTopPool(QUESTION_DB.single, targetSingle);
            const multis = getQuestionsFromTopPool(QUESTION_DB.multi, targetMulti);
            const tfs = getQuestionsFromTopPool(QUESTION_DB.tf, targetTf);
            // --------------------------------

            currentPaper = [...singles, ...multis, ...tfs];

            renderPaper(singles, multis, tfs);
            initAnswerCard(singles, multis, tfs);
            updateFabProgress();

            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('main-header').style.display = 'none';
            document.getElementById('exam-screen').style.display = 'block';
            window.scrollTo(0, 0);

            clearInterval(timerId);
            timerId = setInterval(updateTimer, 1000);
        }

        function renderPaper(singles, multis, tfs) {
            const container = document.getElementById('paper-content');
            container.innerHTML = '';
            let globalIdx = 1;
            globalIndexMap = {};

            const sections = [
                { id: 'single', name: 'ä¸€ã€å•é€‰é¢˜', data: singles, type: 'radio' },
                { id: 'multi', name: 'äºŒã€å¤šé€‰é¢˜', data: multis, type: 'checkbox' },
                { id: 'tf', name: 'ä¸‰ã€åˆ¤æ–­é¢˜', data: tfs, type: 'radio' }
            ];

            sections.forEach(sec => {
                if (sec.data.length === 0) return;
                const title = document.createElement('h3');
                title.className = "section-title";
                title.innerHTML = `${sec.name} <small style="color:#666; font-weight:normal; font-size:12px;">(å…±${sec.data.length}é¢˜)</small>`;
                container.appendChild(title);

                sec.data.forEach(q => {
                    const card = document.createElement('div');
                    card.className = 'question-card';
                    card.id = `q-${q.id}`;
                    globalIndexMap[q.id] = globalIdx;
                    let optsHtml = '';
                    q.options.forEach((opt, index) => {
                        const key = String.fromCharCode(65 + index);
                        const txt = opt.replace(/^[A-F\d][\.\ã€\s]+/, '').trim();
                        optsHtml += `
                        <label class="option-item" id="lbl-${q.id}-${key}">
                            <input type="${sec.type}" name="${q.id}" value="${key}" 
                                   onchange="handleAnswer('${q.id}', '${sec.type}')">
                            <div style="flex:1;">
                                <span style="font-weight:bold; margin-right:5px;">${key}.</span>${txt}
                            </div>
                        </label>`;
                    });

                    card.innerHTML = `
                    <div class="q-header">
                        <span class="q-tag">${sec.name.substr(0, 2)}</span>
                        <span>${globalIdx}. ${q.question}</span>
                    </div>
                    <div class="options">${optsHtml}</div>
                    <div class="analysis-box">
                        <div style="margin-bottom:5px;"><strong>âœ… æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}</strong></div>
                        <div>ğŸ“– ${q.analysis || 'æš‚æ— è§£æ'}</div>
                    </div>
                `;
                    container.appendChild(card);
                    globalIdx++;
                });
            });
        }

        function initAnswerCard(singles, multis, tfs) {
            const body = document.getElementById('answer-card-body');
            body.innerHTML = '';
            let startIdx = 1;
            const sections = [
                { name: 'ä¸€ã€å•é€‰é¢˜', count: singles.length, data: singles },
                { name: 'äºŒã€å¤šé€‰é¢˜', count: multis.length, data: multis },
                { name: 'ä¸‰ã€åˆ¤æ–­é¢˜', count: tfs.length, data: tfs }
            ];

            sections.forEach(sec => {
                if (sec.count === 0) return;
                const secDiv = document.createElement('div');
                secDiv.className = 'card-section';
                secDiv.innerHTML = `<div class="card-sec-title">${sec.name} <span>${sec.count}é¢˜</span></div>`;
                const grid = document.createElement('div');
                grid.className = 'card-grid';
                sec.data.forEach(q => {
                    const item = document.createElement('div');
                    item.className = 'card-item';
                    item.id = `card-btn-${q.id}`;
                    item.innerText = startIdx;
                    item.onclick = function () { scrollToQuestion(q.id); };
                    grid.appendChild(item);
                    startIdx++;
                });
                secDiv.appendChild(grid);
                body.appendChild(secDiv);
            });
        }

        function toggleAnswerCard() {
            const modal = document.getElementById('answer-card-modal');
            const isActive = modal.classList.contains('active');
            if (isActive) {
                modal.classList.remove('active');
                setTimeout(() => { modal.style.display = 'none'; }, 300);
            } else {
                modal.style.display = 'flex';
                setTimeout(() => { modal.classList.add('active'); }, 10);
            }
        }

        function scrollToQuestion(qId) {
            toggleAnswerCard();
            const el = document.getElementById(`q-${qId}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                el.style.border = "2px solid var(--primary)";
                setTimeout(() => { el.style.border = "none"; }, 2000);
            }
        }

        function updateCardStatus(qId, statusClass) {
            const btn = document.getElementById(`card-btn-${qId}`);
            if (btn) {
                btn.classList.remove('answered', 'correct', 'wrong');
                if (statusClass) btn.classList.add(statusClass);
            }
        }

        function updateFabProgress() {
            const answeredCount = Object.keys(userAnswers).filter(k => userAnswers[k]).length;
            document.getElementById('fab-progress').innerText = `${answeredCount}/300`;
        }

        function handleAnswer(qId, type) {
            if (isExamFinished) return;
            const inputs = document.getElementsByName(qId);
            let val = [];
            for (let inp of inputs) {
                const lbl = document.getElementById(`lbl-${qId}-${inp.value}`);
                if (inp.checked) {
                    val.push(inp.value);
                    lbl.classList.add('selected');
                } else {
                    if (type === 'radio' || !inp.checked) lbl.classList.remove('selected');
                }
            }
            const finalVal = type === 'radio' ? (val[0] || '') : val.sort().join('');
            userAnswers[qId] = finalVal;
            if (finalVal) updateCardStatus(qId, 'answered');
            else updateCardStatus(qId, '');
            updateFabProgress();
        }

        function updateTimer() {
            if (timeLeft > 0) {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                const tEl = document.getElementById('timer');
                tEl.innerText = `${m}:${s}`;
                if (timeLeft < 300) tEl.style.color = 'red';
            } else {
                submitExam(false);
            }
        }

        function getStandardAnswer(q) {
            let raw = q.answer.trim();
            let cleanStr = raw.replace(/[\s,\.ã€ï¼Œã€‚]/g, '').toUpperCase();
            const isLetterOnly = /^[A-Z]+$/.test(cleanStr);
            if (isLetterOnly) return cleanStr.split('').sort().join('');
            let mappedKey = "";
            q.options.forEach((opt, index) => {
                const optTxt = opt.replace(/^[A-F\d][\.\ã€\s]+/, '').trim();
                if (optTxt === raw || optTxt === cleanStr) mappedKey = String.fromCharCode(65 + index);
            });
            return mappedKey || raw;
        }

        async function uploadScoreToCloud(score, duration, correctCount, typeStats, uAnswers, paper) {
            const statusEl = document.getElementById('upload-status');

            // V2.0 å‡çº§ï¼šè®¡ç®—é”™é¢˜å’Œæ‰“åŒ…æˆ˜æŠ¥
            const wrongIds = paper.filter(q => {
                const correctKey = getStandardAnswer(q);
                const userAns = uAnswers[q.id] || "";
                return userAns !== correctKey;
            }).map(q => q.id);

            // ã€ä¿®æ”¹ç‚¹5ã€‘æ‰“åŒ…ä¸Šä¼ æ•°æ®
            const detailedStats = {
                breakdown: {
                    single: { c: typeStats.single.correct, a: typeStats.single.answered, t: typeStats.single.total },
                    multi: { c: typeStats.multi.correct, a: typeStats.multi.answered, t: typeStats.multi.total },
                    tf: { c: typeStats.tf.correct, a: typeStats.tf.answered, t: typeStats.tf.total }
                },
                wrongIds: wrongIds,
                paperIds: paper.map(q => q.id)
            };

            const examData = {
                studentName: currentStudent.name || "æ— åæ°",
                studentId: currentStudent.id || "æ— å­¦å·",
                score: parseFloat(score),
                duration: formatDuration(duration),
                correctCount: correctCount,
                submitTime: new Date().toLocaleString(),
                examVersion: EXAM_VERSION,      // æ ‡è®°ä¸ºç²¾ç®€ç‰ˆ
                switchCount: switchScreenCount,
                stats: detailedStats
            };

            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(examData)
                });
                const result = await response.json();
                if (result.success) {
                    statusEl.innerHTML = "âœ… <strong>æˆç»©ä¸Šä¼ æˆåŠŸï¼</strong>";
                    statusEl.style.color = "green";
                } else {
                    statusEl.innerHTML = "âŒ <strong>ä¸Šä¼ å¤±è´¥ï¼š</strong>" + result.error;
                    statusEl.style.color = "red";
                }
            } catch (err) {
                console.error(err);
                statusEl.innerHTML = "âš ï¸ <strong>ç½‘ç»œæ•…éšœï¼Œæ— æ³•ä¸Šä¼ ã€‚è¯·æˆªå›¾ï¼</strong>";
                statusEl.style.color = "red";
            }
        }

        function submitExam(manual) {
            if (manual && !confirm("ç¡®å®šè¦äº¤å·å—ï¼Ÿ")) return;

            clearInterval(timerId);
            isExamFinished = true;
            window.onbeforeunload = null;

            let correctCount = 0;
            // ã€ä¿®æ”¹ç‚¹1ã€‘stats ç»“æ„å¢åŠ  answered å­—æ®µ
            let stats = {
                single: { total: 0, answered: 0, correct: 0 },
                multi: { total: 0, answered: 0, correct: 0 },
                tf: { total: 0, answered: 0, correct: 0 }
            };

            // éå†æ‰¹æ”¹
            currentPaper.forEach(q => {
                // ç»Ÿè®¡æ€»é¢˜æ•°
                if (q.type === 'single') stats.single.total++;
                else if (q.type === 'multi') stats.multi.total++;
                else if (q.type === 'tf') stats.tf.total++;

                const uAns = userAnswers[q.id] || "";

                // ã€ä¿®æ”¹ç‚¹2ã€‘ç»Ÿè®¡å·²ç­”é¢˜æ•° (åªè¦æœ‰ç­”æ¡ˆå°±ç®—å·²ç­”)
                if (uAns !== "") {
                    if (q.type === 'single') stats.single.answered++;
                    else if (q.type === 'multi') stats.multi.answered++;
                    else if (q.type === 'tf') stats.tf.answered++;
                }

                const el = document.getElementById(`q-${q.id}`);
                const inps = document.getElementsByName(q.id);
                for (let inp of inps) inp.disabled = true;

                const correctKey = getStandardAnswer(q);

                if (uAns === correctKey) {
                    correctCount++;
                    // ç»Ÿè®¡æ­£ç¡®æ•°
                    if (q.type === 'single') stats.single.correct++;
                    else if (q.type === 'multi') stats.multi.correct++;
                    else if (q.type === 'tf') stats.tf.correct++;

                    el.classList.add('correct-ans');
                    updateCardStatus(q.id, 'correct');
                } else {
                    el.classList.add('wrong-ans');
                    el.classList.add('show-analysis');
                    updateCardStatus(q.id, 'wrong');
                }
            });

            const score = ((correctCount / 300) * 100).toFixed(1).replace(/\.0$/, '');
            const durationSec = 3600 - timeLeft;

            saveHistory(score, durationSec, correctCount, stats);
            uploadScoreToCloud(score, durationSec, correctCount, stats, userAnswers, currentPaper);

            document.getElementById('score-display').innerText = score;
            document.getElementById('correct-count').innerText = correctCount;
            document.getElementById('result-student-name').innerText = currentStudent.name;

            document.getElementById('main-header').style.display = 'flex';
            document.getElementById('exam-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            document.getElementById('fab-btn').style.display = 'none';

            window.scrollTo(0, 0);
        }

        function reviewWrong() {
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('exam-screen').style.display = 'block';
            document.getElementById('exam-top-bar').style.display = 'none';
            document.getElementById('review-top-bar').style.display = 'flex';
            document.getElementById('exam-bottom-action').style.display = 'none';
            document.getElementById('fab-btn').style.display = 'flex';
            isWrongOnlyMode = false;
            toggleWrongOnly(document.getElementById('filter-btn'));
            window.scrollTo(0, 0);
        }

        function toggleWrongOnly(btn) {
            isWrongOnlyMode = !isWrongOnlyMode;
            const allCards = document.querySelectorAll('.question-card');
            const headers = document.querySelectorAll('.section-title');
            allCards.forEach(card => {
                if (isWrongOnlyMode) {
                    if (!card.classList.contains('wrong-ans')) card.style.display = 'none';
                    else card.style.display = 'block';
                } else {
                    card.style.display = 'block';
                }
            });
            headers.forEach(h => { h.style.display = isWrongOnlyMode ? 'none' : 'block'; });
            const correctBtns = document.querySelectorAll('.card-item.correct');
            correctBtns.forEach(b => { b.style.opacity = isWrongOnlyMode ? '0.1' : '1'; });
            btn.innerText = isWrongOnlyMode ? 'æ˜¾ç¤ºå…¨éƒ¨' : 'åªçœ‹é”™é¢˜';
            btn.style.background = isWrongOnlyMode ? '#ffc107' : '#fff';
        }

        // ===============================================
        // V2.0 å†å²è®°å½•ä¸å¤ç›˜é€»è¾‘ (Copy from index.html)
        // ===============================================

        // ã€ä¿®æ”¹ç‚¹3ã€‘ä¿å­˜é€»è¾‘é€‚é…æ–°ç»“æ„
        function saveHistory(score, durationSec, correctCount, typeStats) {
            // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆ "å¯¹/ç­”/æ€»" å­—ç¬¦ä¸²
            const getStr = (obj) => `${obj.correct}/${obj.answered}/${obj.total}`;

            const statsDisplay = {
                s: getStr(typeStats.single),
                m: getStr(typeStats.multi),
                t: getStr(typeStats.tf)
            };

            // è·å–ç°æœ‰å†å²
            let history = [];
            try {
                history = JSON.parse(localStorage.getItem('kk_exam_history') || '[]');
            } catch (e) {
                history = [];
            }

            // æ„é€ æ–°è®°å½•
            const newRecord = {
                date: new Date().toLocaleString(),
                score: score,
                duration: formatDuration(durationSec),
                stats: statsDisplay,
                snapshot: {
                    qIds: currentPaper.map(q => q.id),
                    answers: userAnswers
                }
            };

            // æ·»åŠ åˆ°å¤´éƒ¨
            history.unshift(newRecord);

            // é™åˆ¶åªä¿ç•™æœ€è¿‘20æ¡
            if (history.length > 20) {
                history = history.slice(0, 20);
            }

            // ä¿å­˜å› LocalStorage
            localStorage.setItem('kk_exam_history', JSON.stringify(history));
        }

        // ã€ä¿®æ”¹ç‚¹4ã€‘å†å²åˆ—è¡¨æ¸²æŸ“é€»è¾‘ (å¢åŠ åˆ—å¤´ï¼Œä¿®æ”¹æ•°æ®å•å…ƒæ ¼)
        function renderHistory() {
            const container = document.getElementById('history-list-container');
            let history = [];
            try {
                history = JSON.parse(localStorage.getItem('kk_exam_history') || '[]');
            } catch (e) {
                console.error("å†å²è®°å½•è§£æå¤±è´¥ï¼Œé‡ç½®ä¸ºç©º", e);
                localStorage.removeItem('kk_exam_history'); // æ•°æ®æŸååˆ™æ¸…ç©º
            }

            if (history.length === 0) {
                container.innerHTML = '<p style="color:#999; font-size:12px; text-align:center; padding:10px;">æš‚æ— ç»ƒä¹ è®°å½•ï¼ŒåŠ æ²¹ï¼</p>';
                return;
            }

            let html = `
        <table class="history-table">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>å•/å¤š/åˆ¤<br><span style="font-size:10px;font-weight:normal">(å¯¹/ç­”/æ€»)</span></th>
                    <th>å¾—åˆ†</th>
                </tr>
            </thead>
            <tbody>
        `;

            history.forEach((item, index) => {
                // 1. åˆ¤æ–­æ˜¯å¦å¯å¤ç›˜ (V2.0+ æ•°æ®æ‰æœ‰ snapshot)
                const canReview = !!item.snapshot;
                const clickAttr = canReview ? `onclick="loadHistorySnapshot(${index})"` : '';
                const rowClass = canReview ? 'history-row-clickable' : '';

                // 2. æ ¸å¿ƒä¿®å¤ï¼šå®‰å…¨è§£æ stats (å…¼å®¹ V1.0 æ—§æ•°æ®)
                // å¦‚æœ item.stats ä¸å­˜åœ¨ï¼Œæˆ–è€…æ ¼å¼ä¸å¯¹ï¼Œç»™é»˜è®¤å€¼
                const safeStats = item.stats || {};
                const s = safeStats.s || '-'; // å¦‚æœæ²¡æœ‰å•é€‰æ•°æ®ï¼Œæ˜¾ç¤º -
                const m = safeStats.m || '-';
                const t = safeStats.t || '-';

                html += `
                <tr class="${rowClass}" ${clickAttr} title="${canReview ? 'ç‚¹å‡»å¤ç›˜' : 'æ—§è®°å½•ä¸å¯å¤ç›˜'}">
                    <td>${item.date.split(' ')[0]}<br><span style="font-size:10px;color:#999">${item.duration}</span></td>
                    <td><span style="font-size:11px;">${s}</span><br><span style="font-size:11px;">${m}</span><br><span style="font-size:11px;">${t}</span></td>
                    <td class="history-score">${item.score}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function loadHistorySnapshot(index) {
            const history = JSON.parse(localStorage.getItem('kk_exam_history'));
            const record = history[index];
            if (!record || !record.snapshot) { alert("è¯¥æ¡è®°å½•æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•å¤ç›˜ã€‚"); return; }
            if (!confirm("ç¡®å®šè¦æ‰“å¼€è¿™æ¡ç»ƒä¹ è®°å½•è¿›è¡Œå¤ç›˜å—ï¼Ÿ\nå½“å‰é¡µé¢å°†è¢«è¦†ç›–ã€‚")) return;

            const qIds = record.snapshot.qIds;
            userAnswers = record.snapshot.answers;

            currentPaper = [];
            qIds.forEach(id => { if (QUESTION_MAP[id]) currentPaper.push(QUESTION_MAP[id]); });

            const singles = currentPaper.filter(q => q.type === 'single');
            const multis = currentPaper.filter(q => q.type === 'multi');
            const tfs = currentPaper.filter(q => q.type === 'tf');

            renderPaper(singles, multis, tfs);
            initAnswerCard(singles, multis, tfs);

            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('exam-screen').style.display = 'block';
            document.getElementById('exam-top-bar').style.display = 'none';
            document.getElementById('review-top-bar').style.display = 'flex';
            document.getElementById('exam-bottom-action').style.display = 'none';
            document.getElementById('fab-btn').style.display = 'flex';

            currentPaper.forEach(q => {
                const uAns = userAnswers[q.id] || "";
                const correctKey = getStandardAnswer(q);
                const el = document.getElementById(`q-${q.id}`);
                const inputs = document.getElementsByName(q.id);
                for (let inp of inputs) {
                    inp.disabled = true;
                    if (uAns.indexOf(inp.value) > -1) {
                        inp.checked = true;
                        const lbl = document.getElementById(`lbl-${q.id}-${inp.value}`);
                        if (lbl) lbl.classList.add('selected');
                    }
                }
                if (uAns === correctKey) {
                    el.classList.add('correct-ans');
                    updateCardStatus(q.id, 'correct');
                } else {
                    el.classList.add('wrong-ans');
                    el.classList.add('show-analysis');
                    updateCardStatus(q.id, 'wrong');
                }
            });
            updateFabProgress();
            window.scrollTo(0, 0);
        }

        function clearHistory() {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ")) {
                localStorage.removeItem('kk_exam_history');
                renderHistory();
            }
        }

        function formatDuration(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}åˆ†${s}ç§’`;
        }
    </script>

</body>

</html>