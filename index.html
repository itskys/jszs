<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025å¹´çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #2d5a27;   /* ä¸»è‰²è°ƒï¼šæ·±ç»¿ */
            --accent: #d9534f;    /* å¼ºè°ƒè‰²ï¼šçº¢è‰² */
            --blue: #007bff;      /* å·²åšï¼šè“è‰² */
            --review-bg: #fff3cd; 
            --review-text: #856404;
            --bg: #f4f4f9;
            --card: #fff;
            --text: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            margin: 0; padding: 0;
            color: var(--text);
            line-height: 1.5;
            -webkit-overflow-scrolling: touch; 
            display: flex; flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 80px; /* ä¸ºæ‚¬æµ®æŒ‰é’®ç•™å‡ºç©ºé—´ */
            flex: 1;
            width: 100%;
        }

        /* ================= Header ================= */
        .header {
            text-align: center; margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex; flex-direction: column; align-items: center;
        }
        .logo-box {
            width: 50px; height: 50px; background: var(--primary); color: white;
            font-weight: 900; font-size: 28px; line-height: 50px; text-align: center;
            border-radius: 8px; letter-spacing: -2px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-bottom: 10px;
        }
        .header h1 { color: var(--primary); margin: 5px 0; font-size: 22px; }
        .sub-title { color: #666; font-size: 13px; }

        /* ================= Components ================= */
        .card-box {
            background: var(--card); padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 20px;
            font-size: 16px; border-radius: 8px; cursor: pointer; transition: 0.2s;
            font-weight: bold; box-shadow: 0 3px #1e3d1a; width: 100%;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 1px #1e3d1a; }
        .btn.danger { background: var(--accent); box-shadow: 0 3px #c9302c; }
        .btn.secondary { background: #6c757d; box-shadow: 0 3px #545b62; }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .input-group input { 
            width: 100%; padding: 12px; border: 1px solid #ddd; 
            border-radius: 8px; font-size: 16px; transition: border 0.3s;
        }
        .input-group input:focus { border-color: var(--primary); outline: none; }

        /* ================= History ================= */
        #history-section { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px; }
        
        /* å‡çº§ç‰ˆå†å²è¡¨æ ¼æ ·å¼ */
        .history-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 10px; table-layout: fixed;}
        .history-table th { text-align: center; color: #666; border-bottom: 2px solid #eee; padding: 8px 2px; background: #f8f9fa;}
        .history-table td { padding: 8px 2px; border-bottom: 1px solid #eee; text-align: center; color: #555; }
        .history-score { color: var(--accent); font-weight: bold; font-size: 14px; }
        
        /* å¯ç‚¹å‡»çš„å†å²è¡Œ */
        .history-row-clickable { cursor: pointer; transition: background 0.2s; }
        .history-row-clickable:active { background-color: #f0f0f0; }
        .history-row-clickable td:first-child { color: var(--blue); font-weight: 500; }

        .clear-hist-btn { background: none; border: none; color: #999; font-size: 12px; text-decoration: underline; margin-top: 10px; padding: 5px; cursor: pointer; }

        /* ================= Exam Screen ================= */
        #exam-screen { display: none; padding-top: 5px; }
        
        .top-bar-compact {
            position: sticky; top: 0; z-index: 900;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: -15px -15px 15px -15px;
            padding: 8px 10px;
            display: flex; align-items: center; justify-content: space-between; gap: 5px;
            transition: all 0.3s;
        }

        .top-bar-review {
            background: var(--review-bg);
            border-bottom: 1px solid #ffeeba;
        }

        .timer-compact {
            font-family: monospace; font-size: 16px; font-weight: bold; color: var(--accent);
            white-space: nowrap;
        }

        /* Submit Button */
        .submit-compact-btn {
            padding: 6px 12px; font-size: 13px; margin: 0; 
            box-shadow: none; width: auto; white-space: nowrap;
            background: var(--accent);
        }

        /* Question Card */
        .question-card { 
            background: var(--card); padding: 15px; margin-bottom: 20px; 
            border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
            scroll-margin-top: 80px; /* å…³é”®ï¼šç¡®ä¿è·³è½¬åä¸è¢«é¡¶éƒ¨æ é®æŒ¡ */
        }
        .q-header { display: flex; align-items: flex-start; gap: 8px; font-size: 16px; font-weight: bold; margin-bottom: 15px; }
        .q-tag { background: var(--primary); color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px; white-space: nowrap; margin-top: 3px; }
        
        .option-item {
            display: flex; align-items: flex-start; min-height: 48px;
            margin: 10px 0; padding: 12px;
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;
            cursor: pointer; transition: all 0.1s;
        }
        .option-item input { margin-top: 4px; margin-right: 10px; transform: scale(1.3); }
        .option-item.selected { background: #e8f5e9; border-color: var(--primary); color: var(--primary); font-weight: 500; }
        
        .analysis-box { background: var(--review-bg); padding: 15px; margin-top: 15px; border-radius: 8px; color: var(--review-text); display: none; font-size: 14px; }
        .show-analysis .analysis-box { display: block; }
        .wrong-ans .q-header { color: var(--accent); }
        .wrong-ans .option-item.selected { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }

        /* ================= ç­”é¢˜å¡ç³»ç»Ÿ ================= */
        .fab-card-btn {
            position: fixed; bottom: 30px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000; cursor: pointer; transition: transform 0.2s;
            font-size: 10px; line-height: 1.2;
        }
        .fab-card-btn:active { transform: scale(0.95); }
        .fab-card-btn i { font-size: 20px; font-style: normal; font-weight: bold; margin-bottom: 2px; }

        .card-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2100;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        .card-modal.active { display: flex; opacity: 1; }
        .card-content {
            background: #fff; width: 100%; height: 80%;
            margin-top: auto; /* åº•éƒ¨å¯¹é½ */
            border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s;
        }
        .card-modal.active .card-content { transform: translateY(0); }

        .card-header {
            padding: 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-header h3 { margin: 0; font-size: 18px; color: var(--primary); }
        .close-card-btn { background: none; border: none; font-size: 24px; color: #999; padding: 0 10px; }

        .card-body {
            flex: 1; overflow-y: auto; padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .card-section { margin-bottom: 20px; }
        .card-sec-title {
            background: #f8f9fa; padding: 8px 12px; font-weight: bold; font-size: 14px;
            color: #555; border-radius: 6px; margin-bottom: 10px;
            display: flex; justify-content: space-between;
        }
        
        .card-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px;
        }
        .card-item {
            width: 40px; height: 40px; border-radius: 50%;
            background: #fff; border: 1px solid #ddd;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: #666; font-weight: bold;
            cursor: pointer; transition: all 0.1s;
        }
        /* çŠ¶æ€é¢œè‰² */
        .card-item.answered { background: var(--blue); color: white; border-color: var(--blue); }
        .card-item.correct { background: var(--primary); color: white; border-color: var(--primary); }
        .card-item.wrong { background: var(--accent); color: white; border-color: var(--accent); }

        /* Footer */
        .footer {
            text-align: center; padding: 20px 0;
            font-size: 12px; color: #aaa;
            border-top: 1px solid #eee; margin-top: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header" id="main-header">
        <div class="logo-box">KK</div>
        <h1>2025å¹´çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ</h1>
        <div class="sub-title">é—­å·æœºè¯• | é™æ—¶60åˆ†é’Ÿ | æ€»åˆ†100åˆ†</div>
    </div>

    <div id="welcome-screen" class="card-box">
        <h2 style="text-align: center; color:var(--primary); margin-top:0;">è€ƒç”Ÿä¿¡æ¯å½•å…¥</h2>
        
        <div style="background:#eef7ee; padding:15px; border-radius:8px; font-size:14px; color:#333; margin-bottom:20px;">
            <p><strong>ğŸ¯ è€ƒè¯•è§„åˆ™ï¼š</strong></p>
            <ul style="padding-left:20px; margin:5px 0;">
                <li><strong>é¢˜é‡ï¼š</strong>300é¢˜ (å•é€‰150+å¤šé€‰100+åˆ¤æ–­50)</li>
                <li><strong>æ—¶é•¿ï¼š</strong>60åˆ†é’Ÿ (äº¤å·åè‡ªåŠ¨ä¸Šä¼ æˆç»©)</li>
            </ul>
        </div>

        <div class="input-group">
            <label>å§“åï¼š</label>
            <input type="text" id="student-name" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
        </div>
        <div class="input-group">
            <label>å­¦å· / ç­çº§ï¼š</label>
            <input type="text" id="student-id" placeholder="ä¾‹å¦‚ï¼š23çº§è®¡ç®—æœº1ç­">
        </div>

        <button class="btn" onclick="startExamWithCheck()">å¼€å§‹è€ƒè¯•</button>
        
        <div id="history-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>ğŸ“œ æœ¬æœºç»ƒä¹ å†å²</strong>
                <button class="clear-hist-btn" onclick="clearHistory()">æ¸…ç©ºè®°å½•</button>
            </div>
            <div id="history-list-container">
                <p style="color:#999; font-size:12px; text-align:center;">æš‚æ— ç»ƒä¹ è®°å½•</p>
            </div>
            <p style="font-size:11px; color:#999; text-align:center; margin-top:5px;">ğŸ’¡ ç‚¹å‡»å†å²è®°å½•å¯ã€å¤ç›˜ã€‘æ•´å¥—è¯•å·è¯¦æƒ…</p>
        </div>
    </div>

    <div id="exam-screen">
        <div class="top-bar-compact" id="exam-top-bar">
            <div class="timer-compact" id="timer">60:00</div>
            <div style="flex:1;"></div>
            <button class="btn danger submit-compact-btn" onclick="submitExam(true)">äº¤å·</button>
        </div>

        <div class="top-bar-compact top-bar-review" id="review-top-bar" style="display:none;">
            <div style="font-weight:bold; color:var(--review-text); font-size:14px;">ğŸ“– å†å²å¤ç›˜æ¨¡å¼</div>
            <div style="display:flex; gap:10px;">
                <button class="mini-nav-btn" id="filter-btn" onclick="toggleWrongOnly(this)" style="width:auto; padding:5px 12px; background:#fff; border-color:#d4a845;">åªçœ‹é”™é¢˜</button>
                <button class="submit-compact-btn" onclick="location.reload()" style="background:#6c757d;">é€€å‡º</button>
            </div>
        </div>

        <div id="paper-content"></div>
        
        <div id="exam-bottom-action" style="padding: 20px 0;">
            <button class="btn danger" onclick="submitExam(true)">ç¡®è®¤æäº¤è¯•å·</button>
        </div>

        <div class="fab-card-btn" id="fab-btn" onclick="toggleAnswerCard()">
            <i>ğŸ“„</i>
            <span id="fab-progress">0/300</span>
        </div>
    </div>

    <div class="card-modal" id="answer-card-modal" onclick="if(event.target===this) toggleAnswerCard()">
        <div class="card-content">
            <div class="card-header">
                <h3>ç­”é¢˜å¡</h3>
                <button class="close-card-btn" onclick="toggleAnswerCard()">Ã—</button>
            </div>
            <div class="card-body" id="answer-card-body">
                </div>
        </div>
    </div>

    <div id="result-screen" class="card-box" style="display:none; text-align:center;">
        <h2 style="color:var(--primary)">è€ƒè¯•ç»“æŸ</h2>
        
        <p style="color:#666; margin:5px 0;">è€ƒç”Ÿï¼š<strong id="result-student-name">--</strong></p>

        <div style="font-size:50px; font-weight:900; color:var(--primary); margin:10px 0;">
            <span id="score-display">0</span> <span style="font-size:18px; color:#666;">åˆ†</span>
        </div>
        <p>ç­”å¯¹: <strong id="correct-count">0</strong> / 300 é¢˜</p>
        
        <div style="background:#fff3cd; padding:10px; border-radius:6px; color:#856404; font-size:14px; margin:20px 0;">
            <span id="upload-status">â³ æ­£åœ¨ä¸Šä¼ æˆç»©...</span><br>
            <span style="font-size:12px; color:#999;">(é”™é¢˜å·²æ ‡çº¢ï¼Œå¯ä¸‹æ»‘æˆ–ä½¿ç”¨ç­”é¢˜å¡æŸ¥çœ‹)</span>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn secondary" onclick="reviewWrong()">æŸ¥çœ‹é”™é¢˜</button>
            <button class="btn" onclick="location.reload()">å†ç»ƒä¸€æ¬¡</button>
        </div>
    </div>

    <div class="footer">
        ç‰ˆæƒæ‰€æœ‰ &copy; 2025 çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ<br>
        Created By <span>Kingkong</span>
    </div>
</div>

<script src="questions_data.js"></script>

<script>
    // ============================================
    // V2.0 æ ¸å¿ƒé€»è¾‘ (ç‰ˆæœ¬æ ‡è¯†ã€åˆ‡å±æ£€æµ‹ã€å…¨é‡ç»Ÿè®¡)
    // ============================================
    
    // 1. ç‰ˆæœ¬æ ‡è¯†ï¼šç”¨äºåå°åŒºåˆ†æ˜¯å®Œæ•´ç‰ˆè¿˜æ˜¯ç²¾ç®€ç‰ˆ
    const EXAM_VERSION = "å®Œæ•´ç‰ˆ"; 
    
    // å…¨å±€å˜é‡å®šä¹‰
    let currentPaper = [];
    let userAnswers = {}; 
    let timeLeft = 3600; 
    let timerId = null;
    let isExamFinished = false;
    let isWrongOnlyMode = false;
    let globalIndexMap = {}; 
    let currentStudent = { name: "", id: "" };
    
    // ã€æ–°å¢ã€‘å…¨å±€é¢˜åº“ç´¢å¼•ï¼Œç”¨äºå†å²è®°å½•å›æº¯ï¼ˆåŠ é€ŸæŸ¥æ‰¾ï¼‰
    let QUESTION_MAP = {}; 
    
    // ã€æ–°å¢ã€‘åˆ‡å±è®¡æ•°å™¨
    let switchScreenCount = 0; 

    // åˆå§‹åŒ–åŠ è½½
    window.onload = function() { 
        initQuestionMap(); // å…ˆå»ºç«‹ç´¢å¼•
        renderHistory();   // æ¸²æŸ“å†å²åˆ—è¡¨
    };

    // 2. åˆå§‹åŒ–é¢˜åº“ç´¢å¼•ï¼šID -> Questionå¯¹è±¡ (å®ç° O(1) æŸ¥æ‰¾)
    function initQuestionMap() {
        if (typeof QUESTION_DB !== 'undefined') {
            ['single', 'multi', 'tf'].forEach(type => {
                QUESTION_DB[type].forEach(q => {
                    QUESTION_MAP[q.id] = q;
                });
            });
        }
    }

    // 3. åˆ‡å±æ£€æµ‹é€»è¾‘
    document.addEventListener("visibilitychange", () => {
        // åªæœ‰åœ¨è€ƒè¯•è¿›è¡Œä¸­ï¼Œä¸”å½“å‰å¤„äºè€ƒè¯•ç•Œé¢æ—¶æ‰è®°å½•
        if (document.hidden && document.getElementById('exam-screen').style.display === 'block' && !isExamFinished) {
            switchScreenCount++;
            document.title = "âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°åˆ‡å±ï¼";
            console.log("åˆ‡å±æ¬¡æ•°:", switchScreenCount);
        } else {
            document.title = "2025å¹´çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ";
        }
    });

    // éšæœºæ‰“ä¹±ç®—æ³•
    function shuffle(arr) {
        let m = arr.length, t, i;
        while (m) {
            i = Math.floor(Math.random() * m--);
            t = arr[m]; arr[m] = arr[i]; arr[i] = t;
        }
        return arr;
    }

    // é˜²è¯¯è§¦é€€å‡º
    window.onbeforeunload = function(e) {
        if (!isExamFinished && document.getElementById('exam-screen').style.display === 'block') {
            e.returnValue = 'è€ƒè¯•è¿›è¡Œä¸­ï¼Œç¦»å¼€å°†ä¸¢å¤±è¿›åº¦';
            return e.returnValue;
        }
    };

    // å¸¦æ ¡éªŒçš„å¼€å§‹è€ƒè¯•
    function startExamWithCheck() {
        const nameInp = document.getElementById('student-name');
        const idInp = document.getElementById('student-id');
        
        const name = nameInp.value.trim();
        const id = idInp.value.trim();

        if (!name || !id) {
            alert("è¯·å…ˆå¡«å†™ã€å§“åã€‘å’Œã€å­¦å·/ç­çº§ã€‘ï¼Œæ‰èƒ½å¼€å§‹è€ƒè¯•ï¼");
            nameInp.focus();
            return;
        }

        currentStudent.name = name;
        currentStudent.id = id;

        startExam();
    }

    // å¼€å§‹è€ƒè¯•æ ¸å¿ƒé€»è¾‘
    function startExam() {
        if (typeof QUESTION_DB === 'undefined') {
            alert("é”™è¯¯ï¼šæœªæ‰¾åˆ°é¢˜åº“æ–‡ä»¶ questions_data.js");
            return;
        }

        userAnswers = {}; 
        switchScreenCount = 0; // é‡ç½®åˆ‡å±æ¬¡æ•°
        
        // æŠ½é¢˜é€»è¾‘
        const singles = shuffle([...QUESTION_DB.single]).slice(0, 150);
        const multis = shuffle([...QUESTION_DB.multi]).slice(0, 100);
        const tfs = shuffle([...QUESTION_DB.tf]).slice(0, 50);

        currentPaper = [...singles, ...multis, ...tfs];
        
        // æ¸²æŸ“ç•Œé¢
        renderPaper(singles, multis, tfs);
        initAnswerCard(singles, multis, tfs);
        updateFabProgress();

        // åˆ‡æ¢è§†å›¾
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('main-header').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'block';
        window.scrollTo(0, 0);

        // å¯åŠ¨è®¡æ—¶å™¨
        clearInterval(timerId);
        timerId = setInterval(updateTimer, 1000);
    }

    // æ¸²æŸ“è¯•å·DOM
    function renderPaper(singles, multis, tfs) {
        const container = document.getElementById('paper-content');
        container.innerHTML = '';
        let globalIdx = 1;
        globalIndexMap = {}; 

        const sections = [
            { id: 'single', name: 'ä¸€ã€å•é€‰é¢˜', data: singles, type: 'radio' },
            { id: 'multi', name: 'äºŒã€å¤šé€‰é¢˜', data: multis, type: 'checkbox' },
            { id: 'tf', name: 'ä¸‰ã€åˆ¤æ–­é¢˜', data: tfs, type: 'radio' }
        ];

        sections.forEach(sec => {
            if(sec.data.length === 0) return;
            
            const title = document.createElement('h3');
            title.className = "section-title";
            title.innerHTML = `${sec.name} <small style="color:#666; font-weight:normal; font-size:12px;">(å…±${sec.data.length}é¢˜)</small>`;
            container.appendChild(title);

            sec.data.forEach(q => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.id = `q-${q.id}`;
                
                globalIndexMap[q.id] = globalIdx;
                
                let optsHtml = '';
                q.options.forEach((opt, index) => {
                    const key = String.fromCharCode(65 + index); 
                    const txt = opt.replace(/^[A-F\d][\.\ã€\s]+/, '').trim();
                    
                    optsHtml += `
                        <label class="option-item" id="lbl-${q.id}-${key}">
                            <input type="${sec.type}" name="${q.id}" value="${key}" 
                                   onchange="handleAnswer('${q.id}', '${sec.type}')">
                            <div style="flex:1;">
                                <span style="font-weight:bold; margin-right:5px;">${key}.</span>${txt}
                            </div>
                        </label>`;
                });

                card.innerHTML = `
                    <div class="q-header">
                        <span class="q-tag">${sec.name.substr(0,2)}</span>
                        <span>${globalIdx}. ${q.question}</span>
                    </div>
                    <div class="options">${optsHtml}</div>
                    <div class="analysis-box">
                        <div style="margin-bottom:5px;"><strong>âœ… æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}</strong></div>
                        <div>ğŸ“– ${q.analysis || 'æš‚æ— è§£æ'}</div>
                    </div>
                `;
                container.appendChild(card);
                globalIdx++;
            });
        });
    }

    // åˆå§‹åŒ–ç­”é¢˜å¡
    function initAnswerCard(singles, multis, tfs) {
        const body = document.getElementById('answer-card-body');
        body.innerHTML = '';
        let startIdx = 1;

        const sections = [
            { name: 'ä¸€ã€å•é€‰é¢˜', count: singles.length, data: singles },
            { name: 'äºŒã€å¤šé€‰é¢˜', count: multis.length, data: multis },
            { name: 'ä¸‰ã€åˆ¤æ–­é¢˜', count: tfs.length, data: tfs }
        ];

        sections.forEach(sec => {
            if(sec.count === 0) return;
            const secDiv = document.createElement('div');
            secDiv.className = 'card-section';
            secDiv.innerHTML = `<div class="card-sec-title">${sec.name} <span>${sec.count}é¢˜</span></div>`;
            const grid = document.createElement('div');
            grid.className = 'card-grid';

            sec.data.forEach(q => {
                const item = document.createElement('div');
                item.className = 'card-item';
                item.id = `card-btn-${q.id}`;
                item.innerText = startIdx;
                item.onclick = function() { scrollToQuestion(q.id); };
                grid.appendChild(item);
                startIdx++;
            });
            secDiv.appendChild(grid);
            body.appendChild(secDiv);
        });
    }

    // ç­”é¢˜å¡å¼€å…³
    function toggleAnswerCard() {
        const modal = document.getElementById('answer-card-modal');
        const isActive = modal.classList.contains('active');
        if (isActive) {
            modal.classList.remove('active');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        } else {
            modal.style.display = 'flex';
            setTimeout(() => { modal.classList.add('active'); }, 10);
        }
    }

    // æ»šåŠ¨å®šä½
    function scrollToQuestion(qId) {
        toggleAnswerCard();
        const el = document.getElementById(`q-${qId}`);
        if(el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            el.style.border = "2px solid var(--primary)";
            setTimeout(() => { el.style.border = "none"; }, 2000);
        }
    }

    function updateCardStatus(qId, statusClass) {
        const btn = document.getElementById(`card-btn-${qId}`);
        if(btn) {
            btn.classList.remove('answered', 'correct', 'wrong');
            if(statusClass) btn.classList.add(statusClass);
        }
    }

    function updateFabProgress() {
        const answeredCount = Object.keys(userAnswers).filter(k => userAnswers[k]).length;
        document.getElementById('fab-progress').innerText = `${answeredCount}/300`;
    }

    // å¤„ç†ä½œç­”
    function handleAnswer(qId, type) {
        if(isExamFinished) return;
        
        const inputs = document.getElementsByName(qId);
        let val = [];
        
        for(let inp of inputs) {
            const lbl = document.getElementById(`lbl-${qId}-${inp.value}`);
            if(inp.checked) {
                val.push(inp.value);
                lbl.classList.add('selected');
            } else {
                if(type === 'radio' || !inp.checked) lbl.classList.remove('selected');
            }
        }

        const finalVal = type === 'radio' ? (val[0]||'') : val.sort().join('');
        userAnswers[qId] = finalVal;

        if(finalVal) updateCardStatus(qId, 'answered');
        else updateCardStatus(qId, '');
        
        updateFabProgress();
    }

    // æ›´æ–°å€’è®¡æ—¶
    function updateTimer() {
        if(timeLeft > 0) {
            timeLeft--;
            const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
            const s = (timeLeft%60).toString().padStart(2,'0');
            const tEl = document.getElementById('timer');
            tEl.innerText = `${m}:${s}`;
            if(timeLeft < 300) tEl.style.color = 'red';
        } else {
            submitExam(false);
        }
    }

    // æ ¸å¿ƒæ¸…æ´—ï¼šè·å–æ ‡å‡†ç­”æ¡ˆKey
    function getStandardAnswer(q) {
        let raw = q.answer.trim();
        let cleanStr = raw.replace(/[\s,\.ã€ï¼Œã€‚]/g, '').toUpperCase();
        const isLetterOnly = /^[A-Z]+$/.test(cleanStr);

        if (isLetterOnly) {
            return cleanStr.split('').sort().join('');
        } else {
            let mappedKey = "";
            q.options.forEach((opt, index) => {
                const optTxt = opt.replace(/^[A-F\d][\.\ã€\s]+/, '').trim();
                if (optTxt === raw || optTxt === cleanStr) {
                    mappedKey = String.fromCharCode(65 + index); 
                }
            });
            return mappedKey || raw;
        }
    }

    // 4. æ•°æ®ä¸Šä¼ æ ¸å¿ƒé€»è¾‘ (åŒ…å«åˆ‡å±æ¬¡æ•°ã€æˆ˜æŠ¥)
    async function uploadScoreToCloud(score, duration, correctCount, typeStats, uAnswers, paper) {
        const statusEl = document.getElementById('upload-status');
        
        // ç®—å‡ºé”™é¢˜IDåˆ—è¡¨
        const wrongIds = paper.filter(q => {
            const correctKey = getStandardAnswer(q);
            const userAns = uAnswers[q.id] || "";
            return userAns !== correctKey;
        }).map(q => q.id);
        
        // æ„é€ è¯¦ç»†æˆ˜æŠ¥ (JSON)
        const detailedStats = {
            breakdown: {
                single: { c: typeStats.single.correct, t: typeStats.single.total },
                multi:  { c: typeStats.multi.correct,  t: typeStats.multi.total },
                tf:     { c: typeStats.tf.correct,     t: typeStats.tf.total }
            },
            wrongIds: wrongIds,
            paperIds: paper.map(q => q.id) // å…¨é‡é¢˜ç›®ID
        };

        const examData = {
            studentName: currentStudent.name || "æ— åæ°",
            studentId: currentStudent.id || "æ— å­¦å·",
            score: parseFloat(score),
            duration: formatDuration(duration),
            correctCount: correctCount,
            submitTime: new Date().toLocaleString(),
            examVersion: EXAM_VERSION,      // ç‰ˆæœ¬
            switchCount: switchScreenCount, // åˆ‡å±æ¬¡æ•°
            stats: detailedStats            // è¯¦ç»†æ•°æ®åŒ…
        };

        try {
            const response = await fetch('/api/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(examData)
            });

            const result = await response.json();

            if (result.success) {
                statusEl.innerHTML = "âœ… <strong>æˆç»©ä¸Šä¼ æˆåŠŸï¼</strong>";
                statusEl.style.color = "green";
            } else {
                statusEl.innerHTML = "âŒ <strong>ä¸Šä¼ å¤±è´¥ï¼š</strong>" + result.error;
                statusEl.style.color = "red";
            }
        } catch (err) {
            console.error(err);
            statusEl.innerHTML = "âš ï¸ <strong>ç½‘ç»œæ•…éšœï¼Œæ— æ³•ä¸Šä¼ ã€‚è¯·æˆªå›¾ï¼</strong>";
            statusEl.style.color = "red";
        }
    }

    // äº¤å·é€»è¾‘
    function submitExam(manual) {
        if(manual && !confirm("ç¡®å®šè¦äº¤å·å—ï¼Ÿ")) return;
        
        clearInterval(timerId);
        isExamFinished = true;
        window.onbeforeunload = null;

        let correctCount = 0;
        // åˆ†ç±»ç»Ÿè®¡åˆå§‹åŒ–
        let stats = {
            single: { total: 0, correct: 0 },
            multi: { total: 0, correct: 0 },
            tf: { total: 0, correct: 0 }
        };

        // éå†æ‰¹æ”¹
        currentPaper.forEach(q => {
            // ç»Ÿè®¡æ€»æ•°
            if(q.type === 'single') stats.single.total++;
            else if(q.type === 'multi') stats.multi.total++;
            else if(q.type === 'tf') stats.tf.total++;

            const uAns = userAnswers[q.id] || "";
            const el = document.getElementById(`q-${q.id}`);
            const inps = document.getElementsByName(q.id);
            for(let inp of inps) inp.disabled = true;

            const correctKey = getStandardAnswer(q);

            if(uAns === correctKey) {
                correctCount++;
                // ç»Ÿè®¡æ­£ç¡®æ•°
                if(q.type === 'single') stats.single.correct++;
                else if(q.type === 'multi') stats.multi.correct++;
                else if(q.type === 'tf') stats.tf.correct++;

                el.classList.add('correct-ans');
                updateCardStatus(q.id, 'correct');
            } else {
                el.classList.add('wrong-ans');
                el.classList.add('show-analysis');
                updateCardStatus(q.id, 'wrong');
            }
        });

        const score = ((correctCount / 300) * 100).toFixed(1).replace(/\.0$/, '');
        const durationSec = 3600 - timeLeft;

        // ä¿å­˜å†å² (V2.0: åŒ…å«å¿«ç…§)
        saveHistory(score, durationSec, correctCount, stats);
        
        // ä¸Šä¼ äº‘ç«¯ (V2.0: åŒ…å«æˆ˜æŠ¥)
        uploadScoreToCloud(score, durationSec, correctCount, stats, userAnswers, currentPaper);

        // UI åˆ‡æ¢
        document.getElementById('score-display').innerText = score;
        document.getElementById('correct-count').innerText = correctCount;
        document.getElementById('result-student-name').innerText = currentStudent.name;
        
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('exam-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        document.getElementById('fab-btn').style.display = 'none';
        
        window.scrollTo(0,0);
    }

    // é”™é¢˜å¤ä¹ æ¨¡å¼
    function reviewWrong() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'block';
        document.getElementById('exam-top-bar').style.display = 'none';
        document.getElementById('review-top-bar').style.display = 'flex';
        document.getElementById('exam-bottom-action').style.display = 'none';
        document.getElementById('fab-btn').style.display = 'flex';
        isWrongOnlyMode = false; 
        toggleWrongOnly(document.getElementById('filter-btn'));
        window.scrollTo(0,0);
    }

    // ç­›é€‰åªçœ‹é”™é¢˜
    function toggleWrongOnly(btn) {
        isWrongOnlyMode = !isWrongOnlyMode;
        const allCards = document.querySelectorAll('.question-card');
        const headers = document.querySelectorAll('.section-title');
        allCards.forEach(card => {
            if (isWrongOnlyMode) {
                if (!card.classList.contains('wrong-ans')) card.style.display = 'none';
                else card.style.display = 'block';
            } else {
                card.style.display = 'block';
            }
        });
        headers.forEach(h => { h.style.display = isWrongOnlyMode ? 'none' : 'block'; });
        const correctBtns = document.querySelectorAll('.card-item.correct');
        correctBtns.forEach(b => { b.style.opacity = isWrongOnlyMode ? '0.1' : '1'; });
        btn.innerText = isWrongOnlyMode ? 'æ˜¾ç¤ºå…¨éƒ¨' : 'åªçœ‹é”™é¢˜';
        btn.style.background = isWrongOnlyMode ? '#ffc107' : '#fff';
    }

    // ===============================================
    // 5. å†å²è®°å½•ä¸å¤ç›˜æ ¸å¿ƒé€»è¾‘ (V2.0 æ–°å¢)
    // ===============================================

    function saveHistory(score, durationSec, correctCount, typeStats) {
        // è®¡ç®—æ­£ç¡®ç‡ç™¾åˆ†æ¯”
        const getPct = (c, t) => t===0 ? '-' : Math.round((c/t)*100) + '%';
        const statsDisplay = {
            s: getPct(typeStats.single.correct, typeStats.single.total),
            m: getPct(typeStats.multi.correct, typeStats.multi.total),
            t: getPct(typeStats.tf.correct, typeStats.tf.total)
        };

        // æå–é¢˜ç›®IDåˆ—è¡¨ï¼ˆå‹ç¼©å­˜å‚¨ï¼‰
        const qIds = currentPaper.map(q => q.id);

        const historyItem = {
            timestamp: Date.now(), // æ’åºç”¨
            date: new Date().toLocaleString(),
            score: score,
            duration: formatDuration(durationSec),
            stats: statsDisplay,
            // å­˜å¿«ç…§ï¼šç”¨æˆ·ç­”æ¡ˆ + é¢˜ç›®IDåˆ—è¡¨
            snapshot: {
                qIds: qIds,
                answers: userAnswers
            }
        };

        let history = JSON.parse(localStorage.getItem('kk_exam_history') || '[]');
        history.unshift(historyItem);
        // é™åˆ¶åªå­˜æœ€è¿‘ 20 æ¡ï¼Œé˜²æ­¢ localStorage çˆ†æ»¡
        if (history.length > 20) history = history.slice(0, 20);
        
        localStorage.setItem('kk_exam_history', JSON.stringify(history));
    }

    function renderHistory() {
        const container = document.getElementById('history-list-container');
        const history = JSON.parse(localStorage.getItem('kk_exam_history') || '[]');
        
        if (history.length === 0) {
            container.innerHTML = '<p style="color:#999; font-size:12px; text-align:center; padding:10px;">æš‚æ— ç»ƒä¹ è®°å½•ï¼ŒåŠ æ²¹ï¼</p>';
            return;
        }

        let html = `
        <table class="history-table">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>å•/å¤š/åˆ¤</th>
                    <th>å¾—åˆ†</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        history.forEach((item, index) => {
            // å…¼å®¹æ—§ç‰ˆæ•°æ®ï¼ˆå¦‚æœæ²¡æœ‰ snapshot å­—æ®µï¼Œåˆ™ä¸å¯ç‚¹å‡»ï¼‰
            const canReview = !!item.snapshot;
            const clickAttr = canReview ? `onclick="loadHistorySnapshot(${index})"` : '';
            const rowClass = canReview ? 'history-row-clickable' : '';
            const stats = item.stats || {s:'-', m:'-', t:'-'}; // å…¼å®¹æ—§ç‰ˆ

            html += `
                <tr class="${rowClass}" ${clickAttr} title="${canReview?'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…':'æ—§è®°å½•ä¸å¯æŸ¥çœ‹'}">
                    <td>${item.date.split(' ')[0]}<br><span style="font-size:10px;color:#999">${item.duration}</span></td>
                    <td><span style="font-size:10px;">${stats.s} / ${stats.m} / ${stats.t}</span></td>
                    <td class="history-score">${item.score}</td>
                </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // ã€æ ¸å¿ƒã€‘åŠ è½½å†å²å¿«ç…§è¿›è¡Œå¤ç›˜
    function loadHistorySnapshot(index) {
        const history = JSON.parse(localStorage.getItem('kk_exam_history'));
        const record = history[index];
        
        if (!record || !record.snapshot) {
            alert("è¯¥æ¡è®°å½•æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•å¤ç›˜ã€‚");
            return;
        }

        if(!confirm("ç¡®å®šè¦æ‰“å¼€è¿™æ¡ç»ƒä¹ è®°å½•è¿›è¡Œå¤ç›˜å—ï¼Ÿ\nå½“å‰é¡µé¢å°†è¢«è¦†ç›–ã€‚")) return;

        // 1. æ¢å¤æ•°æ®
        const qIds = record.snapshot.qIds;
        userAnswers = record.snapshot.answers;
        
        // é‡å»º currentPaper
        currentPaper = [];
        qIds.forEach(id => {
            if (QUESTION_MAP[id]) {
                currentPaper.push(QUESTION_MAP[id]);
            }
        });

        // 2. åˆ†ç±»å¹¶æ¸²æŸ“
        const singles = currentPaper.filter(q => q.type === 'single');
        const multis = currentPaper.filter(q => q.type === 'multi');
        const tfs = currentPaper.filter(q => q.type === 'tf');
        
        renderPaper(singles, multis, tfs);
        initAnswerCard(singles, multis, tfs); // é‡æ–°ç”Ÿæˆç­”é¢˜å¡

        // 3. åˆ‡æ¢UI
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'block';
        document.getElementById('exam-top-bar').style.display = 'none';
        document.getElementById('review-top-bar').style.display = 'flex';
        document.getElementById('exam-bottom-action').style.display = 'none';
        document.getElementById('fab-btn').style.display = 'flex';

        // 4. æ¢å¤ç­”é¢˜çŠ¶æ€ï¼ˆæ ‡çº¢æ ‡ç»¿ã€æ˜¾ç¤ºè§£æã€é€‰ä¸­é€‰é¡¹ï¼‰
        // è¿™ä¸€æ­¥æ˜¯æ¨¡æ‹Ÿ submitExam çš„ UI é€»è¾‘
        currentPaper.forEach(q => {
            const uAns = userAnswers[q.id] || "";
            const correctKey = getStandardAnswer(q);
            const el = document.getElementById(`q-${q.id}`);

            // æ¢å¤é€‰é¡¹é€‰ä¸­çŠ¶æ€ (Checkbox/Radio)
            const inputs = document.getElementsByName(q.id);
            for(let inp of inputs) {
                inp.disabled = true; // ç¦ç”¨
                // æ£€æŸ¥è¯¥é€‰é¡¹æ˜¯å¦è¢«ç”¨æˆ·é€‰è¿‡
                // uAns å¯¹äºå•é€‰æ˜¯ "A", å¤šé€‰æ˜¯ "AB"
                if(uAns.indexOf(inp.value) > -1) {
                    inp.checked = true;
                    // ç»™ label æ·»åŠ  selected æ ·å¼
                    const lbl = document.getElementById(`lbl-${q.id}-${inp.value}`);
                    if(lbl) lbl.classList.add('selected');
                }
            }

            // åˆ¤åˆ†æ ·å¼
            if(uAns === correctKey) {
                el.classList.add('correct-ans');
                updateCardStatus(q.id, 'correct');
            } else {
                el.classList.add('wrong-ans');
                el.classList.add('show-analysis');
                updateCardStatus(q.id, 'wrong');
            }
        });

        updateFabProgress(); // æ›´æ–°æ‚¬æµ®çƒ
        window.scrollTo(0,0);
    }

    function clearHistory() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ")) {
            localStorage.removeItem('kk_exam_history');
            renderHistory();
        }
    }

    function formatDuration(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}åˆ†${s}ç§’`;
    }
</script>

</body>
</html>