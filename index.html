<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025å¹´å†›äº‹çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #2d5a27;   /* ä¸»è‰²è°ƒï¼šæ·±ç»¿ */
            --accent: #d9534f;    /* å¼ºè°ƒè‰²ï¼šçº¢è‰² */
            --blue: #007bff;      /* å·²åšï¼šè“è‰² */
            --review-bg: #fff3cd; 
            --review-text: #856404;
            --bg: #f4f4f9;
            --card: #fff;
            --text: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            margin: 0; padding: 0;
            color: var(--text);
            line-height: 1.5;
            -webkit-overflow-scrolling: touch; 
            display: flex; flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 80px; /* ä¸ºæ‚¬æµ®æŒ‰é’®ç•™å‡ºç©ºé—´ */
            flex: 1;
            width: 100%;
        }

        /* ================= Header ================= */
        .header {
            text-align: center; margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex; flex-direction: column; align-items: center;
        }
        .logo-box {
            width: 50px; height: 50px; background: var(--primary); color: white;
            font-weight: 900; font-size: 28px; line-height: 50px; text-align: center;
            border-radius: 8px; letter-spacing: -2px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-bottom: 10px;
        }
        .header h1 { color: var(--primary); margin: 5px 0; font-size: 22px; }
        .sub-title { color: #666; font-size: 13px; }

        /* ================= Components ================= */
        .card-box {
            background: var(--card); padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 20px;
            font-size: 16px; border-radius: 8px; cursor: pointer; transition: 0.2s;
            font-weight: bold; box-shadow: 0 3px #1e3d1a; width: 100%;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 1px #1e3d1a; }
        .btn.danger { background: var(--accent); box-shadow: 0 3px #c9302c; }
        .btn.secondary { background: #6c757d; box-shadow: 0 3px #545b62; }

        /* ================= History ================= */
        #history-section { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px; }
        .history-table { width: 100%; font-size: 13px; border-collapse: collapse; margin-top: 10px; }
        .history-table th { text-align: left; color: #666; border-bottom: 1px solid #eee; padding: 5px; }
        .history-table td { padding: 8px 5px; border-bottom: 1px solid #eee; }
        .history-score { color: var(--accent); font-weight: bold; }
        .clear-hist-btn { background: none; border: none; color: #999; font-size: 12px; text-decoration: underline; margin-top: 10px; padding: 5px; }

        /* ================= Exam Screen ================= */
        #exam-screen { display: none; padding-top: 5px; }
        
        .top-bar-compact {
            position: sticky; top: 0; z-index: 900;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: -15px -15px 15px -15px;
            padding: 8px 10px;
            display: flex; align-items: center; justify-content: space-between; gap: 5px;
            transition: all 0.3s;
        }

        .top-bar-review {
            background: var(--review-bg);
            border-bottom: 1px solid #ffeeba;
        }

        .timer-compact {
            font-family: monospace; font-size: 16px; font-weight: bold; color: var(--accent);
            white-space: nowrap;
        }

        /* Submit Button */
        .submit-compact-btn {
            padding: 6px 12px; font-size: 13px; margin: 0; 
            box-shadow: none; width: auto; white-space: nowrap;
            background: var(--accent);
        }

        /* Question Card */
        .question-card { 
            background: var(--card); padding: 15px; margin-bottom: 20px; 
            border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
            scroll-margin-top: 80px; /* å…³é”®ï¼šç¡®ä¿è·³è½¬åä¸è¢«é¡¶éƒ¨æ é®æŒ¡ */
        }
        .q-header { display: flex; align-items: flex-start; gap: 8px; font-size: 16px; font-weight: bold; margin-bottom: 15px; }
        .q-tag { background: var(--primary); color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px; white-space: nowrap; margin-top: 3px; }
        
        .option-item {
            display: flex; align-items: flex-start; min-height: 48px;
            margin: 10px 0; padding: 12px;
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;
            cursor: pointer; transition: all 0.1s;
        }
        .option-item input { margin-top: 4px; margin-right: 10px; transform: scale(1.3); }
        .option-item.selected { background: #e8f5e9; border-color: var(--primary); color: var(--primary); font-weight: 500; }
        
        .analysis-box { background: var(--review-bg); padding: 15px; margin-top: 15px; border-radius: 8px; color: var(--review-text); display: none; font-size: 14px; }
        .show-analysis .analysis-box { display: block; }
        .wrong-ans .q-header { color: var(--accent); }
        .wrong-ans .option-item.selected { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }

        /* ================= ç­”é¢˜å¡ç³»ç»Ÿ (New) ================= */
        /* 1. æ‚¬æµ®æŒ‰é’® */
        .fab-card-btn {
            position: fixed; bottom: 30px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000; cursor: pointer; transition: transform 0.2s;
            font-size: 10px; line-height: 1.2;
        }
        .fab-card-btn:active { transform: scale(0.95); }
        .fab-card-btn i { font-size: 20px; font-style: normal; font-weight: bold; margin-bottom: 2px; }

        /* 2. æŠ½å±‰å¼¹çª— */
        .card-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2100;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        .card-modal.active { display: flex; opacity: 1; }
        .card-content {
            background: #fff; width: 100%; height: 80%;
            margin-top: auto; /* åº•éƒ¨å¯¹é½ */
            border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s;
        }
        .card-modal.active .card-content { transform: translateY(0); }

        /* 3. å¼¹çª—å¤´éƒ¨ */
        .card-header {
            padding: 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-header h3 { margin: 0; font-size: 18px; color: var(--primary); }
        .close-card-btn { background: none; border: none; font-size: 24px; color: #999; padding: 0 10px; }

        /* 4. å¼¹çª—å†…å®¹åŒº (å¯æ»šåŠ¨) */
        .card-body {
            flex: 1; overflow-y: auto; padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        /* 5. åˆ†ç»„æŠ˜å æ ‡é¢˜ */
        .card-section { margin-bottom: 20px; }
        .card-sec-title {
            background: #f8f9fa; padding: 8px 12px; font-weight: bold; font-size: 14px;
            color: #555; border-radius: 6px; margin-bottom: 10px;
            display: flex; justify-content: space-between;
        }
        
        /* 6. ç½‘æ ¼å¸ƒå±€ */
        .card-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px;
        }
        .card-item {
            width: 40px; height: 40px; border-radius: 50%;
            background: #fff; border: 1px solid #ddd;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: #666; font-weight: bold;
            cursor: pointer; transition: all 0.1s;
        }
        /* çŠ¶æ€é¢œè‰² */
        .card-item.answered { background: var(--blue); color: white; border-color: var(--blue); }
        .card-item.correct { background: var(--primary); color: white; border-color: var(--primary); }
        .card-item.wrong { background: var(--accent); color: white; border-color: var(--accent); }

        /* Footer */
        .footer {
            text-align: center; padding: 20px 0;
            font-size: 12px; color: #aaa;
            border-top: 1px solid #eee; margin-top: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header" id="main-header">
        <div class="logo-box">KK</div>
        <h1>2025å¹´å†›äº‹çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ</h1>
        <div class="sub-title">é—­å·æœºè¯• | é™æ—¶60åˆ†é’Ÿ | æ€»åˆ†100åˆ†</div>
    </div>

    <div id="welcome-screen" class="card-box">
        <h2 style="text-align: center; color:var(--primary); margin-top:0;">å‡†å¤‡å¥½äº†å—ï¼Ÿ</h2>
        <div style="background:#eef7ee; padding:15px; border-radius:8px; font-size:14px; color:#333; margin-bottom:20px;">
            <p><strong>ğŸ¯ è€ƒè¯•è§„åˆ™ï¼š</strong></p>
            <ul style="padding-left:20px; margin:5px 0;">
                <li><strong>é¢˜é‡ï¼š</strong>300é¢˜ (å•é€‰150+å¤šé€‰100+åˆ¤æ–­50)</li>
                <li><strong>æ—¶é•¿ï¼š</strong>60åˆ†é’Ÿ (å€’è®¡æ—¶ç»“æŸè‡ªåŠ¨äº¤å·)</li>
                <li><strong>è®°å½•ï¼š</strong>ç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜æ‚¨çš„ç»ƒä¹ å†å²</li>
            </ul>
        </div>
        <button class="btn" onclick="startExam()">å¼€å§‹è€ƒè¯•</button>
        
        <div id="history-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>ğŸ“œ ç»ƒä¹ å†å²</strong>
                <button class="clear-hist-btn" onclick="clearHistory()">æ¸…ç©ºè®°å½•</button>
            </div>
            <div id="history-list-container">
                <p style="color:#999; font-size:12px; text-align:center;">æš‚æ— ç»ƒä¹ è®°å½•</p>
            </div>
        </div>
    </div>

    <div id="exam-screen">
        <div class="top-bar-compact" id="exam-top-bar">
            <div class="timer-compact" id="timer">60:00</div>
            <div style="flex:1;"></div>
            <button class="btn danger submit-compact-btn" onclick="submitExam(true)">äº¤å·</button>
        </div>

        <div class="top-bar-compact top-bar-review" id="review-top-bar" style="display:none;">
            <div style="font-weight:bold; color:var(--review-text); font-size:14px;">ğŸ“– é”™é¢˜è§£æ</div>
            <div style="display:flex; gap:10px;">
                <button class="mini-nav-btn" id="filter-btn" onclick="toggleWrongOnly(this)" style="width:auto; padding:5px 12px; background:#fff; border-color:#d4a845;">åªçœ‹é”™é¢˜</button>
                <button class="submit-compact-btn" onclick="location.reload()" style="background:#6c757d;">é€€å‡º</button>
            </div>
        </div>

        <div id="paper-content"></div>
        
        <div id="exam-bottom-action" style="padding: 20px 0;">
            <button class="btn danger" onclick="submitExam(true)">ç¡®è®¤æäº¤è¯•å·</button>
        </div>

        <div class="fab-card-btn" id="fab-btn" onclick="toggleAnswerCard()">
            <i>ğŸ“„</i>
            <span id="fab-progress">0/300</span>
        </div>
    </div>

    <div class="card-modal" id="answer-card-modal" onclick="if(event.target===this) toggleAnswerCard()">
        <div class="card-content">
            <div class="card-header">
                <h3>ç­”é¢˜å¡</h3>
                <button class="close-card-btn" onclick="toggleAnswerCard()">Ã—</button>
            </div>
            <div class="card-body" id="answer-card-body">
                </div>
        </div>
    </div>

    <div id="result-screen" class="card-box" style="display:none; text-align:center;">
        <h2 style="color:var(--primary)">è€ƒè¯•ç»“æŸ</h2>
        <div style="font-size:50px; font-weight:900; color:var(--primary); margin:10px 0;">
            <span id="score-display">0</span> <span style="font-size:18px; color:#666;">åˆ†</span>
        </div>
        <p>ç­”å¯¹: <strong id="correct-count">0</strong> / 300 é¢˜</p>
        <div style="background:#fff3cd; padding:10px; border-radius:6px; color:#856404; font-size:14px; margin:20px 0;">
            é”™é¢˜å·²æ ‡çº¢å¹¶æ˜¾ç¤ºè§£æï¼Œå¯ç‚¹å‡»å³ä¸‹è§’ç­”é¢˜å¡å¿«é€ŸæŸ¥çœ‹
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn secondary" onclick="reviewWrong()">æŸ¥çœ‹é”™é¢˜</button>
            <button class="btn" onclick="location.reload()">å†ç»ƒä¸€æ¬¡</button>
        </div>
    </div>

    <div class="footer">
        ç‰ˆæƒæ‰€æœ‰ &copy; 2025 å†›äº‹çŸ¥è¯†ç«èµ›æ¨¡æ‹Ÿç³»ç»Ÿ<br>
        Created By <span>Kingkong</span>
    </div>
</div>

<script src="questions_data.js"></script>

<script>
    let currentPaper = [];
    let userAnswers = {}; 
    let timeLeft = 3600; 
    let timerId = null;
    let isExamFinished = false;
    let isWrongOnlyMode = false;

    // å…¨å±€é¢˜å·æ˜ å°„ï¼Œç”¨äºç­”é¢˜å¡è·³è½¬
    let globalIndexMap = {}; 

    window.onload = function() { renderHistory(); };

    function shuffle(arr) {
        let m = arr.length, t, i;
        while (m) {
            i = Math.floor(Math.random() * m--);
            t = arr[m]; arr[m] = arr[i]; arr[i] = t;
        }
        return arr;
    }

    window.onbeforeunload = function(e) {
        if (!isExamFinished && document.getElementById('exam-screen').style.display === 'block') {
            e.returnValue = 'è€ƒè¯•è¿›è¡Œä¸­ï¼Œç¦»å¼€å°†ä¸¢å¤±è¿›åº¦';
            return e.returnValue;
        }
    };

    function startExam() {
        if (typeof QUESTION_DB === 'undefined') {
            alert("é”™è¯¯ï¼šæœªæ‰¾åˆ°é¢˜åº“æ–‡ä»¶ questions_data.js");
            return;
        }

        userAnswers = {}; 
        
        const singles = shuffle([...QUESTION_DB.single]).slice(0, 150);
        const multis = shuffle([...QUESTION_DB.multi]).slice(0, 100);
        const tfs = shuffle([...QUESTION_DB.tf]).slice(0, 50);

        currentPaper = [...singles, ...multis, ...tfs];
        
        // æ¸²æŸ“è¯•å·
        renderPaper(singles, multis, tfs);
        // åˆå§‹åŒ–ç­”é¢˜å¡
        initAnswerCard(singles, multis, tfs);
        updateFabProgress();

        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('main-header').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'block';
        window.scrollTo(0, 0);

        clearInterval(timerId);
        timerId = setInterval(updateTimer, 1000);
    }

    function renderPaper(singles, multis, tfs) {
        const container = document.getElementById('paper-content');
        container.innerHTML = '';
        let globalIdx = 1;
        globalIndexMap = {}; // é‡ç½®æ˜ å°„

        const sections = [
            { id: 'single', name: 'ä¸€ã€å•é€‰é¢˜', data: singles, type: 'radio' },
            { id: 'multi', name: 'äºŒã€å¤šé€‰é¢˜', data: multis, type: 'checkbox' },
            { id: 'tf', name: 'ä¸‰ã€åˆ¤æ–­é¢˜', data: tfs, type: 'radio' }
        ];

        sections.forEach(sec => {
            if(sec.data.length === 0) return;
            
            const title = document.createElement('h3');
            title.className = "section-title";
            title.innerHTML = `${sec.name} <small style="color:#666; font-weight:normal; font-size:12px;">(å…±${sec.data.length}é¢˜)</small>`;
            container.appendChild(title);

            sec.data.forEach(q => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.id = `q-${q.id}`;
                
                // è®°å½•é¢˜ç›®IDä¸å…¨å±€åºå·çš„å¯¹åº”å…³ç³»
                globalIndexMap[q.id] = globalIdx;
                
                let optsHtml = '';
                q.options.forEach((opt, index) => {
                    const key = String.fromCharCode(65 + index); 
                    const txt = opt.replace(/^[A-F\d][\.\ã€\s]+/, '').trim();
                    
                    optsHtml += `
                        <label class="option-item" id="lbl-${q.id}-${key}">
                            <input type="${sec.type}" name="${q.id}" value="${key}" 
                                   onchange="handleAnswer('${q.id}', '${sec.type}')">
                            <div style="flex:1;">
                                <span style="font-weight:bold; margin-right:5px;">${key}.</span>${txt}
                            </div>
                        </label>`;
                });

                card.innerHTML = `
                    <div class="q-header">
                        <span class="q-tag">${sec.name.substr(0,2)}</span>
                        <span>${globalIdx}. ${q.question}</span>
                    </div>
                    <div class="options">${optsHtml}</div>
                    <div class="analysis-box">
                        <div style="margin-bottom:5px;"><strong>âœ… æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}</strong></div>
                        <div>ğŸ“– ${q.analysis || 'æš‚æ— è§£æ'}</div>
                    </div>
                `;
                container.appendChild(card);
                globalIdx++;
            });
        });
    }

    // ================= ç­”é¢˜å¡æ ¸å¿ƒé€»è¾‘ =================

    function initAnswerCard(singles, multis, tfs) {
        const body = document.getElementById('answer-card-body');
        body.innerHTML = '';
        let startIdx = 1;

        const sections = [
            { name: 'ä¸€ã€å•é€‰é¢˜', count: singles.length, data: singles },
            { name: 'äºŒã€å¤šé€‰é¢˜', count: multis.length, data: multis },
            { name: 'ä¸‰ã€åˆ¤æ–­é¢˜', count: tfs.length, data: tfs }
        ];

        sections.forEach(sec => {
            if(sec.count === 0) return;

            // åˆ›å»ºåˆ†ç»„å®¹å™¨
            const secDiv = document.createElement('div');
            secDiv.className = 'card-section';
            
            // æ ‡é¢˜
            secDiv.innerHTML = `<div class="card-sec-title">${sec.name} <span>${sec.count}é¢˜</span></div>`;
            
            // ç½‘æ ¼å®¹å™¨
            const grid = document.createElement('div');
            grid.className = 'card-grid';

            // ç”Ÿæˆåœ†åœˆ
            sec.data.forEach(q => {
                const item = document.createElement('div');
                item.className = 'card-item';
                item.id = `card-btn-${q.id}`; // æ–¹ä¾¿åç»­æŸ¥æ‰¾
                item.innerText = startIdx;
                item.onclick = function() { scrollToQuestion(q.id); };
                grid.appendChild(item);
                startIdx++;
            });

            secDiv.appendChild(grid);
            body.appendChild(secDiv);
        });
    }

    function toggleAnswerCard() {
        const modal = document.getElementById('answer-card-modal');
        const isActive = modal.classList.contains('active');
        if (isActive) {
            modal.classList.remove('active');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        } else {
            modal.style.display = 'flex';
            setTimeout(() => { modal.classList.add('active'); }, 10);
        }
    }

    function scrollToQuestion(qId) {
        // å…³é—­ç­”é¢˜å¡
        toggleAnswerCard();
        // æ»šåŠ¨å®šä½
        const el = document.getElementById(`q-${qId}`);
        if(el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // å¯é€‰ï¼šé«˜äº®ä¸€ä¸‹é¢˜ç›®
            el.style.border = "2px solid var(--primary)";
            setTimeout(() => { el.style.border = "none"; }, 2000);
        }
    }

    function updateCardStatus(qId, statusClass) {
        const btn = document.getElementById(`card-btn-${qId}`);
        if(btn) {
            // æ¸…é™¤æ—§çŠ¶æ€
            btn.classList.remove('answered', 'correct', 'wrong');
            if(statusClass) btn.classList.add(statusClass);
        }
    }

    function updateFabProgress() {
        const answeredCount = Object.keys(userAnswers).filter(k => userAnswers[k]).length;
        document.getElementById('fab-progress').innerText = `${answeredCount}/300`;
    }

    // ===============================================

    function handleAnswer(qId, type) {
        if(isExamFinished) return;
        
        const inputs = document.getElementsByName(qId);
        let val = [];
        
        for(let inp of inputs) {
            const lbl = document.getElementById(`lbl-${qId}-${inp.value}`);
            if(inp.checked) {
                val.push(inp.value);
                lbl.classList.add('selected');
            } else {
                if(type === 'radio' || !inp.checked) lbl.classList.remove('selected');
            }
        }

        const finalVal = type === 'radio' ? (val[0]||'') : val.sort().join('');
        const oldVal = userAnswers[qId] || "";
        userAnswers[qId] = finalVal;

        // ã€è”åŠ¨ã€‘æ›´æ–°ç­”é¢˜å¡çŠ¶æ€
        if(finalVal) {
            updateCardStatus(qId, 'answered');
        } else {
            updateCardStatus(qId, ''); // å–æ¶ˆé€‰æ‹©å˜å›ç™½è‰²
        }
        updateFabProgress();
    }

    function updateTimer() {
        if(timeLeft > 0) {
            timeLeft--;
            const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
            const s = (timeLeft%60).toString().padStart(2,'0');
            const tEl = document.getElementById('timer');
            tEl.innerText = `${m}:${s}`;
            if(timeLeft < 300) tEl.style.color = 'red';
        } else {
            submitExam(false);
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–æ ‡å‡†ç­”æ¡ˆKeyï¼ˆå¤„ç†ä¸­æ–‡è½¬å­—æ¯ï¼‰
    function getStandardAnswer(q) {
        let correctKey = q.answer.trim();
        const isLetterOnly = /^[A-Z]+$/i.test(correctKey);
        if (!isLetterOnly) {
            q.options.forEach((opt, index) => {
                const optTxt = opt.replace(/^[A-F\d][\.\ã€\s]+/, '').trim();
                if (optTxt === correctKey) {
                    correctKey = String.fromCharCode(65 + index);
                }
            });
        } else {
            correctKey = correctKey.toUpperCase();
        }
        return correctKey;
    }

    function submitExam(manual) {
        if(manual && !confirm("ç¡®å®šè¦äº¤å·å—ï¼Ÿ")) return;
        
        clearInterval(timerId);
        isExamFinished = true;
        window.onbeforeunload = null;

        let correctCount = 0;
        
        // éå†æ‰€æœ‰é¢˜ç›®è¿›è¡Œæ‰¹æ”¹
        currentPaper.forEach(q => {
            const uAns = userAnswers[q.id] || "";
            const el = document.getElementById(`q-${q.id}`);
            const inps = document.getElementsByName(q.id);
            for(let inp of inps) inp.disabled = true;

            // è·å–æ ‡å‡†ç­”æ¡ˆKey
            const correctKey = getStandardAnswer(q);

            if(uAns === correctKey) {
                correctCount++;
                el.classList.add('correct-ans');
                // ã€è”åŠ¨ã€‘ç­”é¢˜å¡å˜ç»¿
                updateCardStatus(q.id, 'correct');
            } else {
                el.classList.add('wrong-ans');
                el.classList.add('show-analysis');
                // ã€è”åŠ¨ã€‘ç­”é¢˜å¡å˜çº¢
                updateCardStatus(q.id, 'wrong');
            }
        });

        const score = ((correctCount / 300) * 100).toFixed(1).replace(/\.0$/, '');
        saveHistory(score, 3600 - timeLeft);

        document.getElementById('score-display').innerText = score;
        document.getElementById('correct-count').innerText = correctCount;
        
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('exam-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        
        // éšè—æ‚¬æµ®æŒ‰é’®ï¼ˆç»“æœé¡µä¸éœ€è¦ï¼‰
        document.getElementById('fab-btn').style.display = 'none';
        
        window.scrollTo(0,0);
    }

    function reviewWrong() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'block';
        
        document.getElementById('exam-top-bar').style.display = 'none';
        document.getElementById('review-top-bar').style.display = 'flex';
        document.getElementById('exam-bottom-action').style.display = 'none';
        
        // æ¢å¤æ‚¬æµ®æŒ‰é’®ï¼Œæ–¹ä¾¿æŸ¥çœ‹é”™é¢˜åˆ†å¸ƒ
        document.getElementById('fab-btn').style.display = 'flex';

        isWrongOnlyMode = false; 
        toggleWrongOnly(document.getElementById('filter-btn'));
        window.scrollTo(0,0);
    }

    function toggleWrongOnly(btn) {
        isWrongOnlyMode = !isWrongOnlyMode;
        
        const allCards = document.querySelectorAll('.question-card');
        const headers = document.querySelectorAll('.section-title');

        allCards.forEach(card => {
            if (isWrongOnlyMode) {
                if (!card.classList.contains('wrong-ans')) {
                    card.style.display = 'none';
                } else {
                    card.style.display = 'block';
                }
            } else {
                card.style.display = 'block';
            }
        });

        headers.forEach(h => {
            h.style.display = isWrongOnlyMode ? 'none' : 'block';
        });

        // ã€è”åŠ¨ã€‘ç­”é¢˜å¡ä¹Ÿåªæ˜¾ç¤ºé”™é¢˜ï¼Ÿ
        // ç®€å•å¤„ç†ï¼šåªéšè—æ­£ç¡®çš„åœ†åœˆå¯èƒ½ä¼šç ´åå¸ƒå±€ï¼Œæš‚ä¿æŒç­”é¢˜å¡å…¨æ˜¾ï¼Œç”¨é¢œè‰²åŒºåˆ†å³å¯ã€‚
        // æˆ–è€…æˆ‘ä»¬å¯ä»¥è®©ç»¿è‰²çš„å˜é€æ˜ï¼š
        const correctBtns = document.querySelectorAll('.card-item.correct');
        correctBtns.forEach(b => {
            b.style.opacity = isWrongOnlyMode ? '0.1' : '1';
        });

        btn.innerText = isWrongOnlyMode ? 'æ˜¾ç¤ºå…¨éƒ¨' : 'åªçœ‹é”™é¢˜';
        btn.style.background = isWrongOnlyMode ? '#ffc107' : '#fff';
    }

    function saveHistory(score, durationSec) {
        const historyItem = {
            date: new Date().toLocaleString(),
            score: score,
            duration: formatDuration(durationSec)
        };
        let history = JSON.parse(localStorage.getItem('kk_exam_history') || '[]');
        history.unshift(historyItem);
        localStorage.setItem('kk_exam_history', JSON.stringify(history));
    }

    function renderHistory() {
        const container = document.getElementById('history-list-container');
        const history = JSON.parse(localStorage.getItem('kk_exam_history') || '[]');
        
        if (history.length === 0) {
            container.innerHTML = '<p style="color:#999; font-size:12px; text-align:center; padding:10px;">æš‚æ— ç»ƒä¹ è®°å½•ï¼ŒåŠ æ²¹ï¼</p>';
            return;
        }

        let html = `
        <table class="history-table">
            <thead>
                <tr><th>æ—¶é—´</th><th>è€—æ—¶</th><th>å¾—åˆ†</th></tr>
            </thead>
            <tbody>
        `;
        history.slice(0, 5).forEach(item => {
            html += `<tr><td>${item.date.split(' ')[0]}</td><td>${item.duration}</td><td class="history-score">${item.score}</td></tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function clearHistory() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ")) {
            localStorage.removeItem('kk_exam_history');
            renderHistory();
        }
    }

    function formatDuration(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}åˆ†${s}ç§’`;
    }
</script>

</body>
</html>