<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç»©ç®¡ç†åå° - 2025çŸ¥è¯†ç«èµ›</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; color: #2d5a27; font-size: 24px; }
        
        /* æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 10px; }
        button { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-refresh { background-color: #2d5a27; color: white; }
        .btn-refresh:hover { background-color: #1e3d1a; }
        .btn-export { background-color: #007bff; color: white; }
        .btn-export:hover { background-color: #0056b3; }
        .btn-logout { background-color: #6c757d; color: white; }

        /* æœç´¢æ¡† */
        .search-box { margin-bottom: 15px; }
        .search-box input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .search-box input:focus { border-color: #2d5a27; outline: none; }

        /* è¡¨æ ¼æ ·å¼ */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 800px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; font-weight: bold; color: #555; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        tr:hover { background-color: #f0f0f0; }

        /* åˆ†æ•°é¢œè‰² */
        .score-pass { color: #28a745; font-weight: bold; }
        .score-fail { color: #dc3545; font-weight: bold; }
        .meta-info { font-size: 12px; color: #999; }
        
        /* çŠ¶æ€æ¡ */
        #status { margin-bottom: 10px; font-size: 13px; color: #666; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“‹ è€ƒç”Ÿæˆç»©ç›‘æ§</h1>
        <div class="btn-group">
            <button class="btn-refresh" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="btn-export" onclick="exportToCSV()">ğŸ“¥ å¯¼å‡º Excel</button>
            <button class="btn-logout" onclick="logout()">ğŸ”’ é€€å‡º</button>
        </div>
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="ğŸ” è¾“å…¥å§“åæˆ–å­¦å·è¿›è¡Œç­›é€‰...">
    </div>
    
    <div id="status">
        <span id="status-text">ç‚¹å‡»åˆ·æ–°åŠ è½½æ•°æ®...</span>
        <span id="record-count"></span>
    </div>

    <div class="table-wrapper">
        <table id="dataTable">
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th>å§“å</th>
                    <th>å­¦å· / ç­çº§</th>
                    <th style="width: 80px;">åˆ†æ•°</th>
                    <th>ç­”å¯¹é¢˜æ•°</th>
                    <th>è€—æ—¶</th>
                    <th style="width: 160px;">æäº¤æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</div>

<script>
    // é¡µé¢åŠ è½½è‡ªåŠ¨æ‹‰å–æ•°æ®
    window.onload = loadData;

    // æ ¸å¿ƒå‡½æ•°ï¼šåŠ è½½æ•°æ®
    async function loadData() {
        const tbody = document.getElementById('table-body');
        const statusText = document.getElementById('status-text');
        
        // 1. å®‰å…¨æ£€æŸ¥ï¼šæ˜¯å¦æœ‰å¯†ç 
        let password = sessionStorage.getItem('admin_pwd');
        if (!password) {
            password = prompt("ğŸ”’ ç®¡ç†å‘˜èº«ä»½éªŒè¯\nè¯·è¾“å…¥è®¿é—®å¯†ç ï¼š");
            if (!password) {
                statusText.innerText = "â›” æœªéªŒè¯èº«ä»½ï¼Œæ— æ³•æŸ¥çœ‹æ•°æ®ã€‚";
                return;
            }
            sessionStorage.setItem('admin_pwd', password);
        }

        statusText.innerText = "â³ æ­£åœ¨è¿æ¥äº‘æ•°æ®åº“...";
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#999;">æ­£åœ¨è·å–æœ€æ–°æ•°æ®...</td></tr>';

        try {
            // 2. å‘èµ·è¯·æ±‚ (å¸¦å¯†ç å¤´)
            const res = await fetch('/api/records', {
                method: 'GET',
                headers: {
                    'X-Admin-Key': password
                }
            });
            
            // 3. å¤„ç†é”™è¯¯æƒ…å†µ
            if (res.status === 401) {
                alert("âŒ å¯†ç é”™è¯¯ï¼è¯·é‡æ–°è¾“å…¥ã€‚");
                sessionStorage.removeItem('admin_pwd'); // æ¸…é™¤é”™è¯¯å¯†ç 
                location.reload(); // åˆ·æ–°é¡µé¢é‡è¯•
                return;
            }
            
            if (!res.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
            
            // 4. å¤„ç†æ•°æ®
            const data = await res.json();
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">æš‚æ— è€ƒè¯•æ•°æ®</td></tr>';
                statusText.innerText = "âœ… æ•°æ®åŠ è½½å®Œæˆ (ç©ºè®°å½•)";
                document.getElementById('record-count').innerText = "å…± 0 æ¡";
                return;
            }

            tbody.innerHTML = ''; // æ¸…ç©ºåŠ è½½åŠ¨ç”»

            // 5. æ¸²æŸ“è¡¨æ ¼
            data.forEach(row => {
                const tr = document.createElement('tr');
                const scoreClass = row.score >= 60 ? 'score-pass' : 'score-fail';
                
                tr.innerHTML = `
                    <td class="meta-info">${row.id}</td>
                    <td style="font-weight:bold;">${escapeHtml(row.student_name)}</td>
                    <td>${escapeHtml(row.student_id)}</td>
                    <td class="${scoreClass}" style="font-size:16px;">${row.score}</td>
                    <td>${row.correct_count} / 300</td>
                    <td>${row.duration}</td>
                    <td class="meta-info">${row.submit_time}</td>
                `;
                tbody.appendChild(tr);
            });
            
            statusText.innerText = `âœ… æ•°æ®å·²æ›´æ–° (æœ€ååŒæ­¥: ${new Date().toLocaleTimeString()})`;
            document.getElementById('record-count').innerText = `å…± ${data.length} æ¡è®°å½•`;
            
            // é‡æ–°åº”ç”¨å½“å‰çš„æœç´¢è¿‡æ»¤ï¼ˆå¦‚æœæœ‰ï¼‰
            filterTable();

        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red; padding:20px;">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯é…ç½®ã€‚</td></tr>';
            statusText.innerText = "âŒ åŠ è½½å‡ºé”™";
        }
    }

    // åŠŸèƒ½ï¼šå®æ—¶æœç´¢è¿‡æ»¤
    function filterTable() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("dataTable");
        const tr = table.getElementsByTagName("tr");

        // ä»ç¬¬1è¡Œå¼€å§‹å¾ªç¯ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
        for (let i = 1; i < tr.length; i++) {
            // è·å–å§“ååˆ—(1) å’Œ å­¦å·åˆ—(2)
            const tdName = tr[i].getElementsByTagName("td")[1];
            const tdId = tr[i].getElementsByTagName("td")[2];
            
            if (tdName || tdId) {
                const txtValueName = tdName.textContent || tdName.innerText;
                const txtValueId = tdId.textContent || tdId.innerText;
                
                if (txtValueName.toUpperCase().indexOf(filter) > -1 || txtValueId.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    // åŠŸèƒ½ï¼šå¯¼å‡º CSV (Excel)
    function exportToCSV() {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        const rows = document.querySelectorAll("table tr");
        if(rows.length <= 1) {
            alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");
            return;
        }

        let csvContent = "\uFEFF"; // æ·»åŠ  BOM å¤´ï¼Œå¼ºåˆ¶ Excel ä½¿ç”¨ UTF-8 è¯†åˆ«ä¸­æ–‡
        
        rows.forEach(row => {
            // å¦‚æœè¯¥è¡Œè¢«æœç´¢éšè—äº†ï¼Œå°±ä¸å¯¼å‡ºï¼ˆåªå¯¼å‡ºå¯è§çš„ï¼‰
            if (row.style.display === 'none') return;

            const cols = row.querySelectorAll("th, td");
            let rowData = [];
            
            cols.forEach(col => {
                // å¤„ç†æ–‡æœ¬ä¸­çš„é€—å·å’Œå¼•å·ï¼Œé¿å… CSV æ ¼å¼é”™ä¹±
                let text = col.innerText.replace(/"/g, '""');
                // å¼ºåˆ¶å°†æ•°å­—ä½œä¸ºæ–‡æœ¬å¤„ç†ï¼ˆé¿å…ExcelæŠŠé•¿å­¦å·å˜æˆç§‘å­¦è®¡æ•°æ³•ï¼‰ï¼ŒåŠ ä¸Š \t
                // ä½†ä¸ºäº†é€šç”¨æ€§ï¼Œæˆ‘ä»¬ç”¨å¼•å·åŒ…è£¹
                rowData.push(`"${text}"`); 
            });
            
            csvContent += rowData.join(",") + "\n";
        });

        // åˆ›å»ºä¸‹è½½
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const dateStr = new Date().toISOString().slice(0,10); // YYYY-MM-DD
        
        link.setAttribute("href", url);
        link.setAttribute("download", `çŸ¥è¯†ç«èµ›æˆç»©å•_${dateStr}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // åŠŸèƒ½ï¼šé€€å‡ºç™»å½•
    function logout() {
        sessionStorage.removeItem('admin_pwd');
        location.reload();
    }

    // å®‰å…¨å·¥å…·ï¼šé˜²æ­¢ XSS æ³¨å…¥
    function escapeHtml(text) {
        if (!text) return "-";
        return text.replace(/&/g, "&amp;")
                   .replace(/</g, "&lt;")
                   .replace(/>/g, "&gt;")
                   .replace(/"/g, "&quot;")
                   .replace(/'/g, "&#039;");
    }
</script>

</body>
</html>