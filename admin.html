<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç»©ç®¡ç†åå° - 2025çŸ¥è¯†ç«èµ›</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; color: #2d5a27; font-size: 24px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap;}
        button { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-refresh { background-color: #2d5a27; } .btn-refresh:hover { background-color: #1e3d1a; }
        .btn-analyze { background-color: #6610f2; } .btn-analyze:hover { background-color: #520dc2; }
        .btn-export { background-color: #007bff; } .btn-export:hover { background-color: #0056b3; }
        .btn-logout { background-color: #6c757d; }
        
        .controls { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        select, input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .search-box { flex: 1; } .search-box input { width: 100%; box-sizing: border-box;}

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: middle; }
        th { background-color: #f8f9fa; font-weight: bold; color: #555; white-space: nowrap; }
        tr:hover { background-color: #f0f0f0; cursor: pointer; }
        
        .score-pass { color: #28a745; font-weight: bold; }
        .score-fail { color: #dc3545; font-weight: bold; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #fff; }
        .tag-ver { background: #17a2b8; } .tag-switch { background: #dc3545; }
        
        /* é€šç”¨å¼¹çª—æ ·å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; border-radius: 8px; position: relative; display: flex; flex-direction: column; max-height: 90vh; }
        
        /* ã€æ–°å¢ã€‘å¤§å·å¼¹çª—æ ·å¼ (ç”¨äºé¢˜åº“ä½“æ£€) */
        .large-modal { width: 90%; max-width: 1000px; height: 90%; }
        .modal-body { overflow-y: auto; flex: 1; padding-right: 5px; }

        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 20px; top: 10px;}
        .close:hover { color: black; }
        
        /* è¯¦æƒ…é¡µç»Ÿè®¡æ ¼ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; text-align: center; }
        .stat-box { background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #eee; }
        .stat-title { font-size: 12px; color: #666; margin-bottom: 5px; }
        .stat-num { font-size: 16px; font-weight: bold; color: #2d5a27; }

        /* ã€æ–°å¢ã€‘é”™é¢˜åˆ—è¡¨æ ·å¼ */
        .wrong-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; gap: 10px; }
        .wrong-rank { font-size: 18px; font-weight: bold; color: #d9534f; min-width: 30px; }
        .wrong-content { flex: 1; }
        .wrong-q { font-weight: bold; margin-bottom: 5px; color: #333; }
        .wrong-meta { font-size: 12px; color: #666; background: #fff3cd; display: inline-block; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; }
        .wrong-ans-row { font-size: 13px; color: #2d5a27; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š è€ƒç”Ÿæˆç»©ç›‘æ§å°</h1>
        <div class="btn-group">
            <button class="btn-refresh" onclick="loadData()">ğŸ”„ åˆ·æ–°</button>
            <button class="btn-analyze" onclick="analyzeData()">ğŸ“‰ é¢˜åº“ä½“æ£€</button>
            <button class="btn-export" onclick="exportToCSV()">ğŸ“¥ å¯¼å‡º</button>
            <button class="btn-logout" onclick="logout()">ğŸ”’ é€€å‡º</button>
        </div>
    </div>

    <div class="controls">
        <select id="versionFilter" onchange="filterTable()">
            <option value="all">æ‰€æœ‰ç‰ˆæœ¬</option>
            <option value="å®Œæ•´ç‰ˆ">å®Œæ•´ç‰ˆ</option>
            <option value="ç²¾ç®€ç‰ˆ">ç²¾ç®€ç‰ˆ</option>
        </select>
        <div class="search-box">
            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="ğŸ” æœç´¢å§“åæˆ–å­¦å·...">
        </div>
    </div>
    
    <div id="status" style="margin-bottom:10px; font-size:12px; color:#666;">ç‚¹å‡»åˆ·æ–°åŠ è½½æ•°æ®...</div>

    <div class="table-wrapper">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>å§“å/å­¦å·</th>
                    <th>ç‰ˆæœ¬</th>
                    <th>åˆ†æ•°</th>
                    <th>å•é€‰<br><span style="font-size:10px;font-weight:normal">(å¯¹/ç­”/æ€»)</span></th>
                    <th>å¤šé€‰<br><span style="font-size:10px;font-weight:normal">(å¯¹/ç­”/æ€»)</span></th>
                    <th>åˆ¤æ–­<br><span style="font-size:10px;font-weight:normal">(å¯¹/ç­”/æ€»)</span></th>
                    <th>è€—æ—¶</th>
                    <th>åˆ‡å±</th>
                    <th>æäº¤æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('detailModal')">&times;</span>
        <h2 id="modalTitle" style="margin-top:0;">å­¦ç”Ÿè¯¦æƒ…</h2>
        <div class="modal-body">
            <div class="stat-grid">
                <div class="stat-box"><div class="stat-title">å•é€‰ (å¯¹/ç­”/æ€»)</div><div class="stat-num" id="modal-s">-</div></div>
                <div class="stat-box"><div class="stat-title">å¤šé€‰ (å¯¹/ç­”/æ€»)</div><div class="stat-num" id="modal-m">-</div></div>
                <div class="stat-box"><div class="stat-title">åˆ¤æ–­ (å¯¹/ç­”/æ€»)</div><div class="stat-num" id="modal-t">-</div></div>
            </div>
            <div style="margin-top:20px;">
                <h3>âš ï¸ é”™é¢˜è¯Šæ–­ (Top 10)</h3>
                <div id="modal-wrong-list" style="font-size: 13px; color: #555;"></div>
            </div>
        </div>
    </div>
</div>

<div id="analysisModal" class="modal">
    <div class="modal-content large-modal">
        <span class="close" onclick="closeModal('analysisModal')">&times;</span>
        <h2 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“‰ é¢˜åº“å¥åº·åº¦ä½“æ£€æŠ¥å‘Š</h2>
        <div id="analysis-body" class="modal-body">
            </div>
    </div>
</div>

<script src="questions_data.js"></script>
<script>
    let allRecords = []; 
    let QUESTION_MAP = {}; 

    window.onload = function() {
        if(typeof QUESTION_DB !== 'undefined') {
            ['single', 'multi', 'tf'].forEach(t => QUESTION_DB[t].forEach(q => QUESTION_MAP[q.id] = q));
        }
        loadData();
    };

    async function loadData() {
        const tbody = document.getElementById('table-body');
        const status = document.getElementById('status');
        
        let password = sessionStorage.getItem('admin_pwd');
        if (!password) {
            password = prompt("ğŸ”’ è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š");
            if (!password) return;
            sessionStorage.setItem('admin_pwd', password);
        }

        status.innerText = "â³ æ­£åœ¨æ‹‰å–æ•°æ®...";
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px; color:#999;">åŠ è½½ä¸­...</td></tr>';

        try {
            const res = await fetch('/api/records', { headers: { 'X-Admin-Key': password } });
            if (res.status === 401) { alert("å¯†ç é”™è¯¯"); sessionStorage.removeItem('admin_pwd'); location.reload(); return; }
            
            allRecords = await res.json();
            
            if (allRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            renderTable(allRecords);
            status.innerText = `âœ… å…± ${allRecords.length} æ¡è®°å½• (æ›´æ–°äº ${new Date().toLocaleTimeString()})`;

        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="9" style="color:red; text-align:center;">æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        
        const verFilter = document.getElementById('versionFilter').value;
        const searchTxt = document.getElementById('searchInput').value.toUpperCase();

        data.forEach(row => {
            const ver = row.exam_version || "å®Œæ•´ç‰ˆ"; 
            if (verFilter !== 'all' && ver !== verFilter) return;
            
            const txt = (row.student_name + row.student_id).toUpperCase();
            if (searchTxt && txt.indexOf(searchTxt) === -1) return;

            let stats = { breakdown: { single:{c:0,a:0,t:0}, multi:{c:0,a:0,t:0}, tf:{c:0,a:0,t:0} } };
            if (row.stats_json) {
                try { stats = JSON.parse(row.stats_json); } catch(e){}
            }
            
            const fmt = (obj) => {
                const ans = obj.a !== undefined ? obj.a : obj.t; 
                if(obj && obj.t > 0) {
                    const pct = Math.round(obj.c / obj.t * 100);
                    return `<span style="font-size:12px">${obj.c}/${ans}/${obj.t}</span><br><span style="color:#999;font-size:10px">(${pct}%)</span>`;
                }
                return '-';
            };

            const tr = document.createElement('tr');
            tr.onclick = () => showDetail(row, stats);
            
            const scoreClass = row.score >= 60 ? 'score-pass' : 'score-fail';
            const switchTag = (row.switch_count||0) > 0 ? `<span class="tag tag-switch">${row.switch_count}æ¬¡</span>` : '-';

            tr.innerHTML = `
                <td><b>${row.student_name}</b><br><span style="color:#888;font-size:12px">${row.student_id}</span></td>
                <td><span class="tag tag-ver">${ver}</span></td>
                <td class="${scoreClass}" style="font-size:16px">${row.score}</td>
                <td style="text-align:center">${fmt(stats.breakdown.single || {c:0,a:0,t:0})}</td>
                <td style="text-align:center">${fmt(stats.breakdown.multi || {c:0,a:0,t:0})}</td>
                <td style="text-align:center">${fmt(stats.breakdown.tf || {c:0,a:0,t:0})}</td>
                <td>${row.duration}</td>
                <td>${switchTag}</td>
                <td style="color:#888;font-size:12px">${row.submit_time}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function filterTable() {
        renderTable(allRecords);
    }

    function showDetail(row, stats) {
        document.getElementById('modalTitle').innerText = `${row.student_name} çš„è¯¦ç»†æˆ˜æŠ¥`;
        
        const fmtDetail = (obj) => {
            const ans = obj.a !== undefined ? obj.a : obj.t;
            return obj && obj.t > 0 ? `${obj.c} / ${ans} / ${obj.t}` : '-';
        };
        
        document.getElementById('modal-s').innerText = fmtDetail(stats.breakdown.single);
        document.getElementById('modal-m').innerText = fmtDetail(stats.breakdown.multi);
        document.getElementById('modal-t').innerText = fmtDetail(stats.breakdown.tf);

        const listDiv = document.getElementById('modal-wrong-list');
        listDiv.innerHTML = '';
        if (stats.wrongIds && stats.wrongIds.length > 0) {
            stats.wrongIds.slice(0, 10).forEach(id => { 
                const q = QUESTION_MAP[id];
                if(q) listDiv.innerHTML += `<div style="margin-bottom:8px; border-bottom:1px dashed #eee; padding-bottom:4px;">âŒ ${q.question}</div>`;
            });
            if(stats.wrongIds.length > 10) listDiv.innerHTML += '...æ›´å¤šé”™é¢˜è¯·å¯¼å‡ºExcelæŸ¥çœ‹';
        } else {
            listDiv.innerHTML = "ğŸ‰ å¤ªæ£’äº†ï¼Œæ²¡æœ‰é”™é¢˜ï¼";
        }

        document.getElementById('detailModal').style.display = "block";
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    // ã€æ ¸å¿ƒå‡çº§ã€‘é¢˜åº“ä½“æ£€ (å…¨åº“åˆ†æ + Top 20)
    function analyzeData() {
        if(allRecords.length === 0) { alert("æš‚æ— æ•°æ®"); return; }
        
        let wrongCounts = {};
        let coveredIds = new Set();

        // 1. éå†æ‰€æœ‰è®°å½•ï¼Œç»Ÿè®¡é”™è¯¯æ¬¡æ•°å’Œè¦†ç›–ç‡
        allRecords.forEach(r => {
            if(r.stats_json) {
                try {
                    const s = JSON.parse(r.stats_json);
                    // ç»Ÿè®¡é”™é¢˜
                    if(s.wrongIds) s.wrongIds.forEach(id => wrongCounts[id] = (wrongCounts[id]||0) + 1);
                    // ç»Ÿè®¡è¦†ç›–ç‡ (V2.0+ æ•°æ®æ‰æœ‰ paperIds)
                    if(s.paperIds) s.paperIds.forEach(id => coveredIds.add(id));
                } catch(e) {}
            }
        });

        // 2. æ’åºå–å‡º Top 20 é”™é¢˜
        const topWrongIds = Object.keys(wrongCounts).sort((a,b) => wrongCounts[b] - wrongCounts[a]).slice(0, 20);
        
        // 3. è®¡ç®—è¦†ç›–ç‡æ•°æ®
        const totalQ = Object.keys(QUESTION_MAP).length;
        const deadCount = totalQ - coveredIds.size;
        const coveragePct = Math.round(coveredIds.size/totalQ*100);

        // 4. ç”Ÿæˆ HTML æŠ¥å‘Š
        let html = `
            <div style="background:#e8f5e9; padding:15px; border-radius:8px; margin-bottom:20px;">
                <strong>ğŸ¥ æ€»ä½“è¦†ç›–ç‡è¯Šæ–­ï¼š</strong><br>
                é¢˜åº“æ€»æ•°ï¼š${totalQ} é¢˜<br>
                å·²è€ƒé¢˜ç›®ï¼š${coveredIds.size} é¢˜ (è¦†ç›–ç‡ ${coveragePct}%)<br>
                åƒµå°¸é¢˜ç›®ï¼š${deadCount} é¢˜ <small style="color:#666">(ä»æœªè¢«æŠ½åˆ°çš„é¢˜ç›®)</small>
            </div>
            <h3>ğŸ”¥ é«˜é¢‘é”™é¢˜ TOP 20</h3>
        `;

        if(topWrongIds.length === 0) {
            html += '<p style="text-align:center;color:#999">æš‚æ— é”™é¢˜æ•°æ®</p>';
        } else {
            topWrongIds.forEach((id, index) => {
                const q = QUESTION_MAP[id];
                const count = wrongCounts[id];
                if(q) {
                    html += `
                    <div class="wrong-item">
                        <div class="wrong-rank">#${index+1}</div>
                        <div class="wrong-content">
                            <div class="wrong-meta">${count} äººç­”é”™</div>
                            <div class="wrong-q">${q.question}</div>
                            <div style="font-size:12px; color:#666;">
                                ${q.options.map(o=>o.replace(/^[A-F\d][\.\ã€\s]+/, '')).join(' | ')}
                            </div>
                            <div class="wrong-ans-row">âœ… æ­£ç¡®ç­”æ¡ˆï¼š${q.answer}</div>
                        </div>
                    </div>`;
                }
            });
        }

        // 5. æ¸²æŸ“å¹¶æ˜¾ç¤º
        document.getElementById('analysis-body').innerHTML = html;
        document.getElementById('analysisModal').style.display = "block";
    }

    function exportToCSV() {
        const rows = document.querySelectorAll("#dataTable tr");
        if(rows.length <= 1) { alert("æ— æ•°æ®å¯å¯¼å‡º"); return; }
        let csv = "\uFEFF"; 
        rows.forEach(row => {
            if (row.style.display === 'none') return;
            const cols = row.querySelectorAll("th, td");
            let rowData = [];
            cols.forEach(col => rowData.push(`"${col.innerText.replace(/"/g, '""').replace(/\n/g, ' ')}"`));
            csv += rowData.join(",") + "\n";
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
        link.download = `æˆç»©å•_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }
    
    function logout() { sessionStorage.removeItem('admin_pwd'); location.reload(); }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }
</script>
</body>
</html>